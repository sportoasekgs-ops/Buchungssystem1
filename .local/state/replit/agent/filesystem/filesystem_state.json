{"file_contents":{"README.md":{"content":"# SportOase Buchungssystem\n\nEine Web-Anwendung zur Verwaltung von Buchungen für die Schul-SportOase mit Login-System und E-Mail-Benachrichtigungen.\n\n## Funktionen\n\n- **Benutzer-Authentifizierung**: Login-System für Lehrkräfte und Admins\n- **Wochenplan-Anzeige**: Übersicht über feste und freie Zeitslots\n- **Buchungssystem**: Lehrkräfte können 1-5 Schüler für Zeitslots anmelden\n- **Kapazitätskontrolle**: Maximal 5 Schüler pro Zeitslot\n- **Vorlaufzeit**: Buchungen nur bis 60 Minuten vor Stundenbeginn möglich\n- **E-Mail-Benachrichtigungen**: Automatische Benachrichtigung bei neuen Buchungen\n- **Admin-Panel**: Verwaltung von Lehrkräften und Übersicht aller Buchungen\n\n## Installation auf Replit\n\n### 1. Projekt starten\n\nDas Projekt verwendet Python 3.11 und Flask. Die Abhängigkeiten werden automatisch installiert.\n\n### 2. Datenbank initialisieren\n\nVor der ersten Nutzung muss die Datenbank initialisiert werden:\n\n```bash\npython db_setup.py\n```\n\nDies erstellt:\n- Die SQLite-Datenbank `sportoase.db`\n- Einen Standard-Admin-Account:\n  - **E-Mail**: admin@sportoase.de\n  - **Passwort**: admin123\n\n**WICHTIG**: Ändern Sie das Admin-Passwort nach dem ersten Login!\n\n### 3. Anwendung starten\n\n```bash\npython app.py\n```\n\nDie Anwendung läuft dann auf Port 5000 und ist über den Replit-Webview erreichbar.\n\n## Umgebungsvariablen (Optional)\n\nFür E-Mail-Benachrichtigungen können folgende Umgebungsvariablen in Replit konfiguriert werden:\n\n- `SMTP_HOST`: SMTP-Server-Adresse (z.B. smtp.gmail.com)\n- `SMTP_PORT`: SMTP-Port (Standard: 587)\n- `SMTP_USER`: SMTP-Benutzername\n- `SMTP_PASS`: SMTP-Passwort\n- `SMTP_FROM`: Absender-E-Mail-Adresse\n- `ADMIN_EMAIL`: E-Mail-Adresse für Benachrichtigungen\n\nOhne SMTP-Konfiguration werden Benachrichtigungen nur in der Konsole ausgegeben.\n\n## Projektstruktur\n\n```\n.\n├── app.py                  # Haupt-Anwendung mit allen Routen\n├── config.py               # Konfiguration (Stundenplan, SMTP, etc.)\n├── models.py               # Datenbank-Modelle und Funktionen\n├── db_setup.py             # Datenbank-Initialisierung\n├── email_service.py        # E-Mail-Versand\n├── templates/              # HTML-Templates\n│   ├── base.html          # Basis-Template\n│   ├── login.html         # Login-Seite\n│   ├── dashboard.html     # Hauptseite mit Wochenplan\n│   ├── book.html          # Buchungsformular\n│   └── admin.html         # Admin-Bereich\n├── static/                 # Statische Dateien\n│   └── style.css          # CSS-Stylesheet\n└── README.md              # Diese Datei\n```\n\n## Nutzung\n\n### Als Admin\n\n1. Login mit Admin-Zugangsdaten\n2. Navigieren zum Admin-Bereich\n3. Neue Lehrkräfte anlegen\n4. Alle Buchungen einsehen und filtern\n\n### Als Lehrkraft\n\n1. Login mit eigenen Zugangsdaten\n2. Datum im Dashboard auswählen\n3. Verfügbare Zeitslots mit \"Buchen\" öffnen\n4. Anzahl Schüler auswählen (1-5)\n5. Schülerdaten eingeben (Name und Klasse)\n6. Bei freien Slots: Modul auswählen\n7. Buchung abschließen\n\n## Wochenplan-Struktur\n\nDie SportOase läuft während der Unterrichtszeit (1.-6. Stunde):\n\n- **1. Stunde**: 07:50 - 08:35\n- **2. Stunde**: 08:35 - 09:20\n- **3. Stunde**: 09:40 - 10:25\n- **4. Stunde**: 10:25 - 11:20\n- **5. Stunde**: 11:40 - 12:25\n- **6. Stunde**: 12:25 - 13:10\n\n### Feste Angebote\n\nDie Konfiguration in `config.py` definiert feste Angebote pro Wochentag:\n\n- **Montag**: Stunden 1, 3, 5 fest\n- **Dienstag**: Alle Stunden frei\n- **Mittwoch**: Stunden 1, 3, 5 fest\n- **Donnerstag**: Stunden 2, 5 fest\n- **Freitag**: Stunden 2, 4, 5 fest\n\nFreie Stunden können mit folgenden Modulen gebucht werden:\n- Aktivierung\n- Regulation / Entspannung\n- Konflikt-Reset\n- Egal / flexibel\n\n## Anpassungen\n\n### Stundenplan ändern\n\nIn `config.py` können Sie anpassen:\n\n- `PERIOD_TIMES`: Zeiten der Schulstunden\n- `FIXED_OFFERS`: Feste Angebote pro Wochentag\n- `FREE_MODULES`: Verfügbare Module für freie Stunden\n- `MAX_STUDENTS_PER_PERIOD`: Maximale Schüleranzahl\n- `BOOKING_ADVANCE_MINUTES`: Vorlaufzeit für Buchungen\n\n### Datenbank zurücksetzen\n\nUm die Datenbank komplett zurückzusetzen:\n\n```bash\nrm sportoase.db\npython db_setup.py\n```\n\n## Technologie-Stack\n\n- **Backend**: Python 3.11, Flask\n- **Datenbank**: SQLite\n- **Templates**: Jinja2\n- **Styling**: Einfaches CSS (schwarz-weiß)\n- **E-Mail**: SMTP (smtplib)\n- **Zeitzone**: Europe/Berlin (pytz)\n\n## Support\n\nBei Fragen oder Problemen wenden Sie sich an Ihren Administrator.\n","size_bytes":4493},"models.py":{"content":"# Datenbankmodelle für die SportOase-Anwendung mit Flask-SQLAlchemy\n# Diese Datei definiert die Struktur der Datenbank-Tabellen für PostgreSQL\n\nfrom werkzeug.security import generate_password_hash, check_password_hash\nfrom datetime import datetime\nimport json\nfrom database import db\n\nclass User(db.Model):\n    \"\"\"Benutzer-Modell für Lehrkräfte und Admins\"\"\"\n    __tablename__ = 'users'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    username = db.Column(db.String(64), unique=True, nullable=False, index=True)\n    email = db.Column(db.String(120), index=True)\n    password_hash = db.Column(db.String(256), nullable=True)\n    role = db.Column(db.String(20), nullable=False)\n    oauth_provider = db.Column(db.String(50), nullable=True)\n    oauth_id = db.Column(db.String(200), nullable=True)\n    \n    bookings = db.relationship('Booking', backref='teacher', lazy=True)\n    \n    __table_args__ = (\n        db.UniqueConstraint('oauth_provider', 'oauth_id', name='unique_oauth_user'),\n    )\n    \n    def set_password(self, password):\n        \"\"\"Setzt das Passwort (gehasht)\"\"\"\n        self.password_hash = generate_password_hash(password)\n    \n    def check_password(self, password):\n        \"\"\"Überprüft das Passwort\"\"\"\n        return check_password_hash(self.password_hash, password)\n    \n    def to_dict(self):\n        \"\"\"Konvertiert User zu Dictionary für Kompatibilität\"\"\"\n        return {\n            'id': self.id,\n            'username': self.username,\n            'email': self.email,\n            'password_hash': self.password_hash,\n            'role': self.role,\n            'oauth_provider': self.oauth_provider,\n            'oauth_id': self.oauth_id\n        }\n\nclass Booking(db.Model):\n    \"\"\"Buchungs-Modell\"\"\"\n    __tablename__ = 'bookings'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    date = db.Column(db.String(10), nullable=False, index=True)\n    weekday = db.Column(db.String(3), nullable=False)\n    period = db.Column(db.Integer, nullable=False)\n    teacher_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    teacher_name = db.Column(db.String(100))\n    teacher_class = db.Column(db.String(50))\n    students_json = db.Column(db.Text, nullable=False)\n    offer_type = db.Column(db.String(10), nullable=False)\n    offer_label = db.Column(db.String(100), nullable=False)\n    calendar_event_id = db.Column(db.String(200), nullable=True)\n    created_at = db.Column(db.DateTime, nullable=False, default=datetime.utcnow)\n    \n    notifications = db.relationship('Notification', back_populates='booking', cascade='all, delete-orphan', passive_deletes=True)\n    \n    def to_dict(self):\n        \"\"\"Konvertiert Booking zu Dictionary für Kompatibilität\"\"\"\n        return {\n            'id': self.id,\n            'date': self.date,\n            'weekday': self.weekday,\n            'period': self.period,\n            'teacher_id': self.teacher_id,\n            'teacher_name': self.teacher_name,\n            'teacher_class': self.teacher_class,\n            'students_json': self.students_json,\n            'offer_type': self.offer_type,\n            'offer_label': self.offer_label,\n            'calendar_event_id': self.calendar_event_id,\n            'created_at': self.created_at.isoformat() if isinstance(self.created_at, datetime) else self.created_at,\n            'teacher_email': self.teacher.email if self.teacher else None\n        }\n\nclass SlotName(db.Model):\n    \"\"\"Modell für anpassbare Slot-Namen\"\"\"\n    __tablename__ = 'slot_names'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    weekday = db.Column(db.String(3), nullable=False)\n    period = db.Column(db.Integer, nullable=False)\n    label = db.Column(db.String(200), nullable=False)\n    \n    __table_args__ = (\n        db.UniqueConstraint('weekday', 'period', name='unique_weekday_period'),\n    )\n    \n    def to_dict(self):\n        \"\"\"Konvertiert SlotName zu Dictionary\"\"\"\n        return {\n            'id': self.id,\n            'weekday': self.weekday,\n            'period': self.period,\n            'label': self.label\n        }\n\nclass BlockedSlot(db.Model):\n    \"\"\"Modell für von Admins blockierte Slots (z.B. für Beratungsgespräche)\"\"\"\n    __tablename__ = 'blocked_slots'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    date = db.Column(db.String(10), nullable=False, index=True)\n    weekday = db.Column(db.String(3), nullable=False)\n    period = db.Column(db.Integer, nullable=False)\n    reason = db.Column(db.String(200), default='Beratung')\n    blocked_by = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    created_at = db.Column(db.DateTime, nullable=False, default=datetime.utcnow)\n    \n    __table_args__ = (\n        db.UniqueConstraint('date', 'period', name='unique_date_period_block'),\n    )\n    \n    def to_dict(self):\n        \"\"\"Konvertiert BlockedSlot zu Dictionary\"\"\"\n        return {\n            'id': self.id,\n            'date': self.date,\n            'weekday': self.weekday,\n            'period': self.period,\n            'reason': self.reason,\n            'blocked_by': self.blocked_by,\n            'created_at': self.created_at.isoformat() if isinstance(self.created_at, datetime) else self.created_at\n        }\n\nclass Notification(db.Model):\n    \"\"\"Modell für Benachrichtigungen an Admins\"\"\"\n    __tablename__ = 'notifications'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    booking_id = db.Column(db.Integer, db.ForeignKey('bookings.id', ondelete='CASCADE'), nullable=False, index=True)\n    recipient_role = db.Column(db.String(20), nullable=False, default='admin')\n    notification_type = db.Column(db.String(50), nullable=False, default='new_booking')\n    message = db.Column(db.String(500), nullable=False)\n    is_read = db.Column(db.Boolean, default=False, nullable=False, index=True)\n    read_at = db.Column(db.DateTime, nullable=True)\n    created_at = db.Column(db.DateTime, nullable=False, default=datetime.utcnow, index=True)\n    metadata_json = db.Column(db.Text, nullable=True)\n    \n    booking = db.relationship('Booking', back_populates='notifications')\n    \n    def to_dict(self):\n        \"\"\"Konvertiert Notification zu Dictionary\"\"\"\n        metadata = None\n        if self.metadata_json:\n            try:\n                metadata = json.loads(self.metadata_json)\n            except:\n                metadata = None\n        \n        return {\n            'id': self.id,\n            'booking_id': self.booking_id,\n            'recipient_role': self.recipient_role,\n            'notification_type': self.notification_type,\n            'message': self.message,\n            'is_read': self.is_read,\n            'read_at': self.read_at.isoformat() if isinstance(self.read_at, datetime) else self.read_at,\n            'created_at': self.created_at.isoformat() if isinstance(self.created_at, datetime) else self.created_at,\n            'metadata': metadata,\n            'booking': self.booking.to_dict() if self.booking else None\n        }\n\n# Hilfsfunktionen für Kompatibilität mit dem alten Code\n\ndef create_user(username, password, role, email=None):\n    \"\"\"Erstellt einen neuen Benutzer in der Datenbank\"\"\"\n    try:\n        user = User(username=username, email=email, role=role)\n        user.set_password(password)\n        db.session.add(user)\n        db.session.commit()\n        return user.id\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Erstellen des Benutzers: {e}\")\n        return None\n\ndef get_user_by_username(username):\n    \"\"\"Sucht einen Benutzer anhand des Benutzernamens\"\"\"\n    user = User.query.filter_by(username=username).first()\n    return user.to_dict() if user else None\n\ndef get_user_by_email(email):\n    \"\"\"Sucht einen Benutzer anhand der E-Mail-Adresse\"\"\"\n    user = User.query.filter_by(email=email).first()\n    return user.to_dict() if user else None\n\ndef get_or_create_oauth_user(email, username, oauth_provider, oauth_id, role='teacher'):\n    \"\"\"Erstellt oder aktualisiert einen OAuth-Benutzer\"\"\"\n    try:\n        user = User.query.filter_by(oauth_provider=oauth_provider, oauth_id=oauth_id).first()\n        \n        if user:\n            user.email = email\n            user.username = username\n            user.role = role\n        else:\n            user = User(\n                username=username,\n                email=email,\n                role=role,\n                oauth_provider=oauth_provider,\n                oauth_id=oauth_id,\n                password_hash=None\n            )\n            db.session.add(user)\n        \n        db.session.commit()\n        return user.to_dict()\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Erstellen/Aktualisieren des OAuth-Benutzers: {e}\")\n        return None\n\ndef get_user_by_id(user_id):\n    \"\"\"Sucht einen Benutzer anhand der ID\"\"\"\n    user = User.query.get(user_id)\n    return user.to_dict() if user else None\n\ndef verify_password(user_dict, password):\n    \"\"\"Überprüft, ob das eingegebene Passwort korrekt ist\"\"\"\n    user = User.query.get(user_dict['id'])\n    return user.check_password(password) if user else False\n\ndef change_user_password(user_id, old_password, new_password):\n    \"\"\"Ändert das Passwort eines Benutzers\"\"\"\n    try:\n        user = User.query.get(user_id)\n        if not user:\n            return {'success': False, 'error': 'Benutzer nicht gefunden'}\n        \n        if not user.check_password(old_password):\n            return {'success': False, 'error': 'Altes Passwort ist falsch'}\n        \n        user.set_password(new_password)\n        db.session.commit()\n        return {'success': True, 'message': 'Passwort erfolgreich geändert'}\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Ändern des Passworts: {e}\")\n        return {'success': False, 'error': 'Fehler beim Ändern des Passworts'}\n\ndef get_all_users():\n    \"\"\"Gibt alle Benutzer zurück (für Admin-Ansicht)\"\"\"\n    users = User.query.order_by(User.role, User.username).all()\n    return [u.to_dict() for u in users]\n\ndef create_booking(date, weekday, period, teacher_id, students, offer_type, offer_label, teacher_name=None, teacher_class=None, calendar_event_id=None):\n    \"\"\"Erstellt eine neue Buchung in der Datenbank\"\"\"\n    try:\n        students_json = json.dumps(students, ensure_ascii=False)\n        booking = Booking(\n            date=date,\n            weekday=weekday,\n            period=period,\n            teacher_id=teacher_id,\n            teacher_name=teacher_name,\n            teacher_class=teacher_class,\n            students_json=students_json,\n            offer_type=offer_type,\n            offer_label=offer_label,\n            calendar_event_id=calendar_event_id,\n            created_at=datetime.now()\n        )\n        db.session.add(booking)\n        db.session.commit()\n        return booking.id\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Erstellen der Buchung: {e}\")\n        return None\n\ndef get_bookings_for_date_period(date, period):\n    \"\"\"Gibt alle Buchungen für ein bestimmtes Datum und Stunde zurück\"\"\"\n    bookings = Booking.query.filter_by(date=date, period=period).order_by(Booking.created_at).all()\n    return [b.to_dict() for b in bookings]\n\ndef count_students_for_period(date, period):\n    \"\"\"Zählt die Gesamtzahl der Schüler für eine bestimmte Stunde\"\"\"\n    bookings = get_bookings_for_date_period(date, period)\n    total = 0\n    for booking in bookings:\n        students = json.loads(booking['students_json'])\n        total += len(students)\n    return total\n\ndef check_student_double_booking(student_name, student_class, date, period, exclude_booking_id=None):\n    \"\"\"\n    Prüft, ob ein Schüler bereits für dieses Datum und diese Stunde gebucht ist.\n    \n    Args:\n        student_name: Name des Schülers\n        student_class: Klasse des Schülers\n        date: Datum (YYYY-MM-DD)\n        period: Stunde (1-6)\n        exclude_booking_id: Optional - Buchungs-ID die ausgeschlossen werden soll (für Updates)\n    \n    Returns:\n        Dict mit 'is_booked' (bool) und 'booking_info' (str) oder None\n    \"\"\"\n    bookings = get_bookings_for_date_period(date, period)\n    \n    for booking in bookings:\n        # Überspringe die Buchung, die ausgeschlossen werden soll\n        if exclude_booking_id and booking['id'] == exclude_booking_id:\n            continue\n            \n        students = json.loads(booking['students_json'])\n        \n        # Prüfe ob der Schüler in dieser Buchung ist\n        for student in students:\n            if (student.get('name', '').strip().lower() == student_name.strip().lower() and \n                student.get('klasse', '').strip().lower() == student_class.strip().lower()):\n                \n                return {\n                    'is_booked': True,\n                    'booking_info': f\"{student_name} ({student_class}) ist bereits in '{booking['offer_label']}' bei {booking['teacher_name']} gebucht.\"\n                }\n    \n    return {'is_booked': False, 'booking_info': None}\n\ndef get_all_bookings():\n    \"\"\"Gibt alle Buchungen zurück (für Admin-Ansicht)\"\"\"\n    bookings = Booking.query.order_by(Booking.date.desc(), Booking.period).all()\n    return [b.to_dict() for b in bookings]\n\ndef get_bookings_by_date(date):\n    \"\"\"Gibt alle Buchungen für ein bestimmtes Datum zurück\"\"\"\n    bookings = Booking.query.filter_by(date=date).order_by(Booking.period).all()\n    return [b.to_dict() for b in bookings]\n\ndef get_bookings_for_week(start_date, end_date):\n    \"\"\"Gibt alle Buchungen für eine Woche zurück\"\"\"\n    bookings = Booking.query.filter(Booking.date >= start_date, Booking.date <= end_date).order_by(Booking.date, Booking.period).all()\n    return [b.to_dict() for b in bookings]\n\ndef get_booking_by_id(booking_id):\n    \"\"\"Gibt eine einzelne Buchung anhand der ID zurück\"\"\"\n    booking = Booking.query.get(booking_id)\n    return booking.to_dict() if booking else None\n\ndef update_booking(booking_id, date, weekday, period, teacher_id, students, offer_type, offer_label, teacher_name=None, teacher_class=None):\n    \"\"\"Aktualisiert eine bestehende Buchung in der Datenbank\"\"\"\n    try:\n        booking = Booking.query.get(booking_id)\n        if not booking:\n            return False\n        \n        booking.date = date\n        booking.weekday = weekday\n        booking.period = period\n        booking.teacher_id = teacher_id\n        booking.teacher_name = teacher_name\n        booking.teacher_class = teacher_class\n        booking.students_json = json.dumps(students, ensure_ascii=False)\n        booking.offer_type = offer_type\n        booking.offer_label = offer_label\n        \n        db.session.commit()\n        return True\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Aktualisieren der Buchung: {e}\")\n        return False\n\ndef delete_booking(booking_id, delete_calendar_event_callback=None):\n    \"\"\"Löscht eine Buchung aus der Datenbank und optional den Google Calendar Eintrag\"\"\"\n    try:\n        booking = Booking.query.get(booking_id)\n        if not booking:\n            return False\n        \n        # Wenn Callback für Calendar-Löschung übergeben wurde, nutze ihn\n        if delete_calendar_event_callback and booking.calendar_event_id:\n            try:\n                delete_calendar_event_callback(booking.calendar_event_id)\n            except Exception as e:\n                print(f\"Warnung: Calendar Eintrag konnte nicht gelöscht werden: {e}\")\n        \n        db.session.delete(booking)\n        db.session.commit()\n        return True\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Löschen der Buchung: {e}\")\n        return False\n\ndef get_custom_slot_name(weekday, period):\n    \"\"\"Gibt den angepassten Slot-Namen aus der Datenbank zurück\"\"\"\n    slot = SlotName.query.filter_by(weekday=weekday, period=period).first()\n    return slot.label if slot else None\n\ndef update_slot_name(weekday, period, label):\n    \"\"\"Aktualisiert oder erstellt einen angepassten Slot-Namen\"\"\"\n    try:\n        slot = SlotName.query.filter_by(weekday=weekday, period=period).first()\n        if slot:\n            slot.label = label\n        else:\n            slot = SlotName(weekday=weekday, period=period, label=label)\n            db.session.add(slot)\n        \n        db.session.commit()\n        return True\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Aktualisieren des Slot-Namens: {e}\")\n        return False\n\ndef get_all_custom_slot_names():\n    \"\"\"Gibt alle angepassten Slot-Namen zurück\"\"\"\n    slots = SlotName.query.all()\n    return [s.to_dict() for s in slots]\n\ndef is_slot_blocked(date, period):\n    \"\"\"Prüft, ob ein Slot für ein bestimmtes Datum und Stunde blockiert ist\"\"\"\n    blocked = BlockedSlot.query.filter_by(date=date, period=period).first()\n    return blocked is not None\n\ndef get_blocked_slot(date, period):\n    \"\"\"Gibt den blockierten Slot zurück, falls vorhanden\"\"\"\n    blocked = BlockedSlot.query.filter_by(date=date, period=period).first()\n    return blocked.to_dict() if blocked else None\n\ndef block_slot(date, weekday, period, admin_id, reason='Beratung'):\n    \"\"\"Blockiert einen Slot für Beratungsgespräche (nur Admin)\"\"\"\n    try:\n        if is_slot_blocked(date, period):\n            return False\n        \n        blocked = BlockedSlot(\n            date=date,\n            weekday=weekday,\n            period=period,\n            reason=reason,\n            blocked_by=admin_id,\n            created_at=datetime.now()\n        )\n        db.session.add(blocked)\n        db.session.commit()\n        return True\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Blockieren des Slots: {e}\")\n        return False\n\ndef unblock_slot(date, period):\n    \"\"\"Gibt einen blockierten Slot wieder frei\"\"\"\n    try:\n        blocked = BlockedSlot.query.filter_by(date=date, period=period).first()\n        if not blocked:\n            return False\n        \n        db.session.delete(blocked)\n        db.session.commit()\n        return True\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Freigeben des Slots: {e}\")\n        return False\n\ndef get_blocked_slots_for_date(date):\n    \"\"\"Gibt alle blockierten Slots für ein bestimmtes Datum zurück\"\"\"\n    blocked_slots = BlockedSlot.query.filter_by(date=date).all()\n    return [b.to_dict() for b in blocked_slots]\n\ndef get_blocked_slots_for_week(start_date, end_date):\n    \"\"\"Gibt alle blockierten Slots für eine Woche zurück\"\"\"\n    blocked_slots = BlockedSlot.query.filter(BlockedSlot.date >= start_date, BlockedSlot.date <= end_date).all()\n    return [b.to_dict() for b in blocked_slots]\n\ndef get_all_blocked_slots():\n    \"\"\"Gibt alle blockierten Slots zurück (für Admin-Ansicht)\"\"\"\n    blocked_slots = BlockedSlot.query.order_by(BlockedSlot.date.desc(), BlockedSlot.period).all()\n    return [b.to_dict() for b in blocked_slots]\n\ndef create_notification(booking_id, message, notification_type='new_booking', recipient_role='admin', metadata=None):\n    \"\"\"Erstellt eine neue Benachrichtigung\"\"\"\n    try:\n        metadata_json = json.dumps(metadata, ensure_ascii=False) if metadata else None\n        notification = Notification(\n            booking_id=booking_id,\n            recipient_role=recipient_role,\n            notification_type=notification_type,\n            message=message,\n            metadata_json=metadata_json,\n            is_read=False,\n            created_at=datetime.now()\n        )\n        db.session.add(notification)\n        db.session.commit()\n        return notification.id\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Erstellen der Benachrichtigung: {e}\")\n        return None\n\ndef get_unread_notifications(recipient_role='admin'):\n    \"\"\"Gibt alle ungelesenen Benachrichtigungen zurück\"\"\"\n    notifications = Notification.query.filter_by(recipient_role=recipient_role, is_read=False).order_by(Notification.created_at.desc()).all()\n    return [n.to_dict() for n in notifications]\n\ndef get_recent_notifications(recipient_role='admin', limit=10):\n    \"\"\"Gibt die neuesten Benachrichtigungen zurück (gelesen und ungelesen)\"\"\"\n    notifications = Notification.query.filter_by(recipient_role=recipient_role).order_by(Notification.created_at.desc()).limit(limit).all()\n    return [n.to_dict() for n in notifications]\n\ndef mark_notification_as_read(notification_id):\n    \"\"\"Markiert eine Benachrichtigung als gelesen\"\"\"\n    try:\n        notification = Notification.query.get(notification_id)\n        if not notification:\n            return False\n        notification.is_read = True\n        notification.read_at = datetime.now()\n        db.session.commit()\n        return True\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Markieren der Benachrichtigung: {e}\")\n        return False\n\ndef mark_all_notifications_as_read(recipient_role='admin'):\n    \"\"\"Markiert alle Benachrichtigungen als gelesen\"\"\"\n    try:\n        notifications = Notification.query.filter_by(recipient_role=recipient_role, is_read=False).all()\n        for notification in notifications:\n            notification.is_read = True\n            notification.read_at = datetime.now()\n        db.session.commit()\n        return True\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Markieren aller Benachrichtigungen: {e}\")\n        return False\n\ndef get_unread_notification_count(recipient_role='admin'):\n    \"\"\"Gibt die Anzahl der ungelesenen Benachrichtigungen zurück\"\"\"\n    return Notification.query.filter_by(recipient_role=recipient_role, is_read=False).count()\n\ndef delete_notification(notification_id):\n    \"\"\"Löscht eine Benachrichtigung\"\"\"\n    try:\n        notification = Notification.query.get(notification_id)\n        if not notification:\n            return False\n        db.session.delete(notification)\n        db.session.commit()\n        return True\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Löschen der Benachrichtigung: {e}\")\n        return False\n","size_bytes":22068},"app.py":{"content":"# Haupt-Anwendungsdatei für die SportOase-Buchungssystem\n# Diese Datei enthält alle Routen (URLs) und die Logik der Webanwendung\n\nfrom flask import Flask, render_template, request, redirect, url_for, session, flash, Response, jsonify\nfrom datetime import datetime, timedelta, date\nfrom werkzeug.middleware.proxy_fix import ProxyFix\nimport pytz\nimport json\nimport os\nimport queue\nimport threading\n\n# Flask-App erstellen\napp = Flask(__name__)\n\n# Session-Secret aus Umgebungsvariable (MUSS gesetzt sein!)\nsession_secret = os.environ.get('SESSION_SECRET')\nif not session_secret:\n    raise RuntimeError(\n        \"SESSION_SECRET Umgebungsvariable ist nicht gesetzt! \"\n        \"Bitte setzen Sie einen sicheren, zufälligen Wert in Replit Secrets.\"\n    )\napp.secret_key = session_secret\napp.wsgi_app = ProxyFix(app.wsgi_app, x_proto=1, x_host=1)\n\n# SSE Broadcaster für Echtzeit-Benachrichtigungen\nnotification_subscribers = []\nsubscribers_lock = threading.Lock()\n\ndef broadcast_notification(notification_data):\n    \"\"\"Sendet eine Benachrichtigung an alle verbundenen SSE-Clients\"\"\"\n    with subscribers_lock:\n        dead_queues = []\n        for q in notification_subscribers:\n            try:\n                q.put_nowait(notification_data)\n            except queue.Full:\n                dead_queues.append(q)\n        \n        for q in dead_queues:\n            notification_subscribers.remove(q)\n\n# CSRF-Token Generierung und Validierung\nimport secrets\n\ndef generate_csrf_token():\n    \"\"\"Generiert ein CSRF-Token und speichert es in der Session\"\"\"\n    if 'csrf_token' not in session:\n        session['csrf_token'] = secrets.token_hex(32)\n    return session['csrf_token']\n\ndef validate_csrf_token(token):\n    \"\"\"Validiert das CSRF-Token\"\"\"\n    return token == session.get('csrf_token')\n\n@app.context_processor\ndef inject_csrf_token():\n    \"\"\"Macht csrf_token in allen Templates verfügbar\"\"\"\n    return dict(csrf_token=generate_csrf_token())\n\n# Datenbank-Konfiguration\ndb_uri = os.environ.get(\"DATABASE_URL\") or os.environ.get(\"SQLALCHEMY_DATABASE_URI\")\n\n# Strip whitespace from database URL (in case of accidental spaces)\nif db_uri:\n    db_uri = db_uri.strip()\n\nif not db_uri:\n    raise RuntimeError(\n        \"Keine DB-URL gefunden. Bitte DATABASE_URL \"\n        \"oder SQLALCHEMY_DATABASE_URI setzen.\"\n    )\n\napp.config[\"SQLALCHEMY_DATABASE_URI\"] = db_uri\napp.config[\"SQLALCHEMY_ENGINE_OPTIONS\"] = {\n    \"pool_recycle\": 300,\n    \"pool_pre_ping\": True,\n}\napp.config[\"SQLALCHEMY_TRACK_MODIFICATIONS\"] = False\n\n# Importiere zentrale Datenbank-Instanz\nfrom database import db\n\n# Initialisiere SQLAlchemy mit der App\ndb.init_app(app)\n\n# Importiere Modelle und Hilfsfunktionen\nfrom models import (\n    create_user, get_user_by_username, get_user_by_email, \n    get_user_by_id, verify_password, get_all_users, create_booking,\n    get_bookings_for_date_period, count_students_for_period, get_all_bookings,\n    get_bookings_by_date, get_bookings_for_week, get_booking_by_id,\n    update_booking, delete_booking, User, Booking,\n    create_notification, get_unread_notifications, get_recent_notifications,\n    mark_notification_as_read, mark_all_notifications_as_read,\n    get_unread_notification_count, get_booking_by_id, check_student_double_booking,\n    change_user_password, get_or_create_oauth_user\n)\nfrom config import *\nfrom email_service import send_booking_notification\n\n# Google Calendar Service importieren und initialisieren\nfrom calendar_service import init_calendar_service, is_calendar_enabled, create_booking_event, delete_booking_event\n\n# Initialisiere Google Calendar Service (optional)\nwith app.app_context():\n    init_calendar_service()\n\n# IServ OAuth-Integration initialisieren\nfrom oauth_config import init_oauth, determine_user_role\noauth_instance, iserv_client = init_oauth(app)\n\n# Schema-Erstellung erfolgt explizit über db_setup.py\n# Nicht automatisch bei jedem Import!\n\n# Hilfsfunktion: Zeitzone Europe/Berlin\ndef get_berlin_tz():\n    \"\"\"Gibt die Zeitzone Europe/Berlin zurück\"\"\"\n    return pytz.timezone('Europe/Berlin')\n\n# Hilfsfunktion: Prüft, ob Benutzer eingeloggt ist\ndef login_required(f):\n    \"\"\"Decorator-Funktion: Schützt Routen, sodass nur eingeloggte Benutzer darauf zugreifen können\"\"\"\n    from functools import wraps\n    @wraps(f)\n    def decorated_function(*args, **kwargs):\n        if 'user_id' not in session:\n            flash('Bitte melden Sie sich an.', 'error')\n            return redirect(url_for('login'))\n        return f(*args, **kwargs)\n    return decorated_function\n\n# Hilfsfunktion: Prüft, ob Benutzer Admin ist\ndef admin_required(f):\n    \"\"\"Decorator-Funktion: Schützt Routen, sodass nur Admins darauf zugreifen können\"\"\"\n    from functools import wraps\n    @wraps(f)\n    def decorated_function(*args, **kwargs):\n        if 'user_id' not in session:\n            flash('Bitte melden Sie sich an.', 'error')\n            return redirect(url_for('login'))\n        user = get_user_by_id(session['user_id'])\n        if not user or user['role'] != 'admin':\n            flash('Zugriff verweigert. Nur Admins haben Zugriff.', 'error')\n            return redirect(url_for('dashboard'))\n        return f(*args, **kwargs)\n    return decorated_function\n\n# Hilfsfunktion: Gibt Informationen über eine Stunde zurück\ndef get_period_info(weekday, period):\n    \"\"\"\n    Gibt Informationen über eine Stunde zurück (fest/frei, Bezeichnung)\n    weekday: z.B. \"Mon\", \"Tue\", ...\n    period: 1-6\n    \"\"\"\n    from models import get_custom_slot_name\n    \n    if weekday in FIXED_OFFERS and period in FIXED_OFFERS[weekday]:\n        custom_label = get_custom_slot_name(weekday, period)\n        label = custom_label if custom_label else FIXED_OFFERS[weekday][period]\n        return {\n            'type': 'fest',\n            'label': label\n        }\n    else:\n        return {\n            'type': 'frei',\n            'label': 'Freie Wahl'\n        }\n\n# Hilfsfunktion: Prüft, ob ein Datum in der Vergangenheit liegt\ndef is_past_date(check_date, period=None):\n    \"\"\"\n    Prüft, ob ein Datum (und optional eine Stunde) in der Vergangenheit liegt\n    \"\"\"\n    berlin_tz = get_berlin_tz()\n    now = datetime.now(berlin_tz)\n    \n    if period is not None:\n        # Prüfe mit spezifischer Stunde\n        period_start_time = PERIOD_TIMES[period]['start']\n        hour, minute = map(int, period_start_time.split(':'))\n        period_datetime = berlin_tz.localize(\n            datetime.combine(check_date, datetime.min.time()).replace(hour=hour, minute=minute)\n        )\n        return period_datetime < now\n    else:\n        # Prüfe nur Datum\n        today = now.date()\n        return check_date < today\n\n# Hilfsfunktion: Prüft, ob eine Buchung zeitlich möglich ist\ndef check_booking_time(booking_date, period):\n    \"\"\"\n    Prüft, ob die Buchung mindestens 60 Minuten in der Zukunft liegt\n    Gibt (True, None) zurück wenn OK, sonst (False, Fehlermeldung)\n    \"\"\"\n    berlin_tz = get_berlin_tz()\n    now = datetime.now(berlin_tz)\n    \n    # Erstelle Datetime-Objekt für den Stundenbeginn\n    period_start_time = PERIOD_TIMES[period]['start']\n    hour, minute = map(int, period_start_time.split(':'))\n    \n    # Kombiniere Datum und Zeit\n    period_datetime = berlin_tz.localize(\n        datetime.combine(booking_date, datetime.min.time()).replace(hour=hour, minute=minute)\n    )\n    \n    # Berechne Zeitdifferenz\n    time_diff = period_datetime - now\n    \n    if time_diff.total_seconds() < BOOKING_ADVANCE_MINUTES * 60:\n        return False, f\"Buchungen sind nur bis {BOOKING_ADVANCE_MINUTES} Minuten vor Stundenbeginn möglich.\"\n    \n    return True, None\n\n# Route: Startseite (leitet zum Dashboard weiter)\n@app.route('/')\ndef index():\n    \"\"\"Startseite - leitet zum Dashboard oder Login weiter\"\"\"\n    if 'user_id' in session:\n        return redirect(url_for('dashboard'))\n    return redirect(url_for('login'))\n\n# Route: Login-Seite\n@app.route('/login', methods=['GET', 'POST'])\ndef login():\n    \"\"\"Login-Seite für Lehrkräfte und Admins\"\"\"\n    if request.method == 'POST':\n        username = request.form.get('username', '').strip()\n        password = request.form.get('password', '')\n        \n        # Suche Benutzer in Datenbank\n        user = get_user_by_username(username)\n        \n        if user and verify_password(user, password):\n            # Login erfolgreich - speichere in Session\n            session['user_id'] = user['id']\n            session['user_username'] = user['username']\n            session['user_email'] = user['email'] if user['email'] else ''\n            session['user_role'] = user['role']\n            flash(f'Willkommen, {username}!', 'success')\n            return redirect(url_for('dashboard'))\n        else:\n            flash('Ungültiger Benutzername oder Passwort.', 'error')\n    \n    iserv_enabled = bool(os.environ.get('ISERV_CLIENT_ID') and os.environ.get('ISERV_CLIENT_SECRET'))\n    return render_template('login.html', iserv_enabled=iserv_enabled)\n\n# Route: IServ SSO Login initiieren\n@app.route('/login/iserv')\ndef login_iserv():\n    \"\"\"Startet den IServ OAuth2-Login-Flow\"\"\"\n    if not iserv_client:\n        flash('IServ-Login ist nicht konfiguriert.', 'error')\n        return redirect(url_for('login'))\n    \n    redirect_uri = url_for('oauth_callback', _external=True)\n    return iserv_client.authorize_redirect(redirect_uri)\n\n# Route: OAuth Callback von IServ\n@app.route('/oauth/callback')\ndef oauth_callback():\n    \"\"\"Callback-Route für IServ OAuth2\"\"\"\n    if not iserv_client:\n        flash('IServ-Login ist nicht konfiguriert.', 'error')\n        return redirect(url_for('login'))\n    \n    try:\n        token = iserv_client.authorize_access_token()\n        userinfo = token.get('userinfo')\n        \n        if not userinfo:\n            userinfo = iserv_client.userinfo(token=token)\n        \n        email = userinfo.get('email')\n        sub = userinfo.get('sub')\n        name = userinfo.get('name', email)\n        \n        if not email or not sub:\n            flash('Fehler beim Abrufen der Benutzerdaten von IServ.', 'error')\n            return redirect(url_for('login'))\n        \n        role = determine_user_role(userinfo)\n        username = email.split('@')[0]\n        \n        user = get_or_create_oauth_user(\n            email=email,\n            username=username,\n            oauth_provider='iserv',\n            oauth_id=sub,\n            role=role\n        )\n        \n        if not user:\n            flash('Fehler beim Erstellen des Benutzers.', 'error')\n            return redirect(url_for('login'))\n        \n        session['user_id'] = user['id']\n        session['user_username'] = user['username']\n        session['user_email'] = user['email']\n        session['user_role'] = user['role']\n        \n        flash(f'Willkommen, {name}!', 'success')\n        return redirect(url_for('dashboard'))\n        \n    except Exception as e:\n        print(f\"OAuth Fehler: {e}\")\n        flash('Fehler beim IServ-Login. Bitte versuchen Sie es erneut.', 'error')\n        return redirect(url_for('login'))\n\n# Route: Logout\n@app.route('/logout')\ndef logout():\n    \"\"\"Meldet den Benutzer ab\"\"\"\n    session.clear()\n    flash('Sie wurden abgemeldet.', 'info')\n    return redirect(url_for('login'))\n\n# Route: Passwort ändern\n@app.route('/change_password', methods=['GET', 'POST'])\n@admin_required\ndef change_password():\n    \"\"\"Ermöglicht Admins Passwörter zu ändern\"\"\"\n    if request.method == 'POST':\n        # CSRF-Token Validierung\n        csrf_token = request.form.get('csrf_token', '')\n        if not validate_csrf_token(csrf_token):\n            flash('Ungültiges Sicherheits-Token. Bitte versuchen Sie es erneut.', 'error')\n            return redirect(url_for('change_password'))\n        \n        old_password = request.form.get('old_password', '')\n        new_password = request.form.get('new_password', '')\n        confirm_password = request.form.get('confirm_password', '')\n        \n        # Validierung\n        if not old_password or not new_password or not confirm_password:\n            flash('Bitte füllen Sie alle Felder aus.', 'error')\n            return redirect(url_for('change_password'))\n        \n        if new_password != confirm_password:\n            flash('Die neuen Passwörter stimmen nicht überein.', 'error')\n            return redirect(url_for('change_password'))\n        \n        if len(new_password) < 6:\n            flash('Das neue Passwort muss mindestens 6 Zeichen lang sein.', 'error')\n            return redirect(url_for('change_password'))\n        \n        # Passwort ändern\n        result = change_user_password(session['user_id'], old_password, new_password)\n        \n        if result['success']:\n            flash(result['message'], 'success')\n            return redirect(url_for('dashboard'))\n        else:\n            flash(result['error'], 'error')\n            return redirect(url_for('change_password'))\n    \n    return render_template('change_password.html')\n\n# Route: Dashboard\n@app.route('/dashboard')\n@login_required\ndef dashboard():\n    \"\"\"Hauptseite - zeigt Wochenplan und Buchungsmöglichkeiten\"\"\"\n    # Hole aktuelles Datum oder gewähltes Datum\n    selected_date_str = request.args.get('date', datetime.now(get_berlin_tz()).strftime('%Y-%m-%d'))\n    \n    try:\n        selected_date = datetime.strptime(selected_date_str, '%Y-%m-%d').date()\n    except:\n        selected_date = datetime.now(get_berlin_tz()).date()\n    \n    # Wochentag ermitteln (Mon, Tue, ...)\n    weekday = selected_date.strftime('%a')\n    weekday_name = selected_date.strftime('%A')  # Ausgeschriebener Name\n    \n    # Deutsche Wochentagsnamen\n    weekday_names_de = {\n        'Monday': 'Montag',\n        'Tuesday': 'Dienstag',\n        'Wednesday': 'Mittwoch',\n        'Thursday': 'Donnerstag',\n        'Friday': 'Freitag',\n        'Saturday': 'Samstag',\n        'Sunday': 'Sonntag'\n    }\n    weekday_name_de = weekday_names_de.get(weekday_name, weekday_name)\n    \n    # Erstelle Stundenplan für den Tag\n    from models import is_slot_blocked, get_blocked_slot\n    schedule = []\n    for period in range(1, 7):\n        period_info = get_period_info(weekday, period)\n        student_count = count_students_for_period(selected_date_str, period)\n        available = MAX_STUDENTS_PER_PERIOD - student_count\n        \n        # Prüfe, ob Slot blockiert ist\n        blocked_slot = get_blocked_slot(selected_date_str, period)\n        is_blocked = blocked_slot is not None\n        \n        # Prüfe, ob Termin in der Vergangenheit liegt\n        is_past = is_past_date(selected_date, period)\n        \n        # Prüfe, ob es ein Wochenende ist\n        is_weekend = selected_date.weekday() in [5, 6]\n        \n        # Prüfe, ob Buchung zeitlich möglich ist\n        can_book, time_message = check_booking_time(selected_date, period)\n        \n        # can_book muss False sein für vergangene Termine oder Wochenenden\n        if is_past:\n            can_book = False\n            if not time_message:\n                time_message = \"Dieser Termin liegt in der Vergangenheit.\"\n        elif is_weekend:\n            can_book = False\n            if not time_message:\n                time_message = \"Buchungen sind am Wochenende nicht möglich.\"\n        \n        schedule.append({\n            'period': period,\n            'time': f\"{PERIOD_TIMES[period]['start']} - {PERIOD_TIMES[period]['end']}\",\n            'type': period_info['type'],\n            'label': period_info['label'],\n            'booked': student_count,\n            'available': available,\n            'can_book': can_book and available > 0 and not is_blocked and not is_past and not is_weekend,\n            'time_message': time_message,\n            'blocked': blocked_slot,\n            'blocked_reason': blocked_slot.get('reason', 'Beratung') if blocked_slot else None,\n            'is_past': is_past,\n            'is_weekend': is_weekend\n        })\n    \n    # Erstelle Wochenübersicht (Montag-Freitag) mit Buchungsdaten\n    from models import get_bookings_for_week, get_blocked_slots_for_week, is_slot_blocked\n    \n    # Berechne Montag und Freitag der aktuellen Woche\n    days_since_monday = selected_date.weekday()\n    monday = selected_date - timedelta(days=days_since_monday)\n    friday = monday + timedelta(days=4)\n    \n    # Berechne Kalenderwoche\n    calendar_week = monday.isocalendar()[1]\n    calendar_year = monday.isocalendar()[0]\n    \n    # Berechne vorherige und nächste Woche für Navigation\n    prev_week_monday = monday - timedelta(days=7)\n    next_week_monday = monday + timedelta(days=7)\n    \n    # Hole alle Buchungen für diese Woche\n    week_bookings = get_bookings_for_week(monday.strftime('%Y-%m-%d'), friday.strftime('%Y-%m-%d'))\n    \n    # Hole alle blockierten Slots für diese Woche\n    blocked_slots = get_blocked_slots_for_week(monday.strftime('%Y-%m-%d'), friday.strftime('%Y-%m-%d'))\n    \n    # Organisiere blockierte Slots nach Datum und Stunde\n    blocked_by_date_period = {}\n    for blocked in blocked_slots:\n        key = f\"{blocked['date']}_{blocked['period']}\"\n        blocked_by_date_period[key] = blocked\n    \n    # Organisiere Buchungen nach Datum und Stunde\n    bookings_by_date_period = {}\n    for booking in week_bookings:\n        booking_dict = dict(booking)\n        key = f\"{booking_dict['date']}_{booking_dict['period']}\"\n        if key not in bookings_by_date_period:\n            bookings_by_date_period[key] = []\n        \n        students = json.loads(booking_dict['students_json']) if booking_dict.get('students_json') else []\n        bookings_by_date_period[key].append({\n            'teacher_name': booking_dict.get('teacher_name', 'N/A'),\n            'teacher_class': booking_dict.get('teacher_class', 'N/A'),\n            'student_count': len(students),\n            'students': students,\n            'offer_label': booking_dict.get('offer_label', 'N/A')\n        })\n    \n    week_overview = []\n    weekdays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri']\n    weekday_names = ['Mo', 'Di', 'Mi', 'Do', 'Fr']\n    \n    for i, wd in enumerate(weekdays):\n        day_date = monday + timedelta(days=i)\n        day_date_str = day_date.strftime('%Y-%m-%d')\n        \n        day_schedule = []\n        for period in range(1, 7):\n            info = get_period_info(wd, period)\n            key = f\"{day_date_str}_{period}\"\n            period_bookings = bookings_by_date_period.get(key, [])\n            blocked_slot = blocked_by_date_period.get(key)\n            \n            total_students = sum(b['student_count'] for b in period_bookings)\n            available = MAX_STUDENTS_PER_PERIOD - total_students\n            \n            # Prüfe, ob Termin in der Vergangenheit liegt\n            is_past = is_past_date(day_date, period)\n            \n            # Prüfe, ob es ein Wochenende ist\n            is_weekend = day_date.weekday() in [5, 6]\n            \n            # Prüfe, ob Buchung für diesen Slot möglich ist\n            can_book, _ = check_booking_time(day_date, period)\n            can_book = can_book and available > 0 and not blocked_slot and not is_past and not is_weekend\n            \n            day_schedule.append({\n                'period': period,\n                'type': info['type'],\n                'label': info['label'],\n                'bookings': period_bookings,\n                'total_students': total_students,\n                'available': available,\n                'can_book': can_book,\n                'blocked': blocked_slot,\n                'blocked_reason': blocked_slot.get('reason', 'Beratung') if blocked_slot else None,\n                'is_past': is_past,\n                'is_weekend': is_weekend\n            })\n        week_overview.append({\n            'weekday': wd,\n            'name': weekday_names[i],\n            'date': day_date_str,\n            'date_formatted': day_date.strftime('%d.%m.'),\n            'schedule': day_schedule\n        })\n    \n    return render_template('dashboard.html',\n                         selected_date=selected_date,\n                         weekday=weekday_name_de,\n                         schedule=schedule,\n                         week_overview=week_overview,\n                         user_role=session.get('user_role'),\n                         calendar_week=calendar_week,\n                         calendar_year=calendar_year,\n                         prev_week_date=prev_week_monday.strftime('%Y-%m-%d'),\n                         next_week_date=next_week_monday.strftime('%Y-%m-%d'),\n                         monday_date=monday.strftime('%d.%m.%Y'),\n                         friday_date=friday.strftime('%d.%m.%Y'))\n\n# Route: Buchungsseite\n@app.route('/book/<date_str>/<int:period>', methods=['GET', 'POST'])\n@login_required\ndef book(date_str, period):\n    \"\"\"Seite zum Erstellen einer neuen Buchung\"\"\"\n    \n    # Validiere Datum und Stunde\n    try:\n        booking_date = datetime.strptime(date_str, '%Y-%m-%d').date()\n    except:\n        flash('Ungültiges Datum.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    if period < 1 or period > 6:\n        flash('Ungültige Stunde.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    # Prüfe, ob Termin in der Vergangenheit liegt\n    if is_past_date(booking_date, period):\n        flash('Dieser Termin liegt in der Vergangenheit und kann nicht gebucht werden.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    # Prüfe, ob es ein Wochenende ist (Samstag=5, Sonntag=6)\n    if booking_date.weekday() in [5, 6]:\n        flash('Buchungen sind am Wochenende nicht möglich.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    # Ermittle Wochentag und Stundeninfo\n    weekday = booking_date.strftime('%a')\n    period_info = get_period_info(weekday, period)\n    \n    # Prüfe verfügbare Plätze\n    current_students = count_students_for_period(date_str, period)\n    available_spots = MAX_STUDENTS_PER_PERIOD - current_students\n    \n    if available_spots <= 0:\n        flash('Diese Stunde ist bereits voll belegt.', 'error')\n        return redirect(url_for('dashboard', date=date_str))\n    \n    # Prüfe, ob Slot für Beratung blockiert ist (nur Admins können blockierte Slots sehen)\n    from models import is_slot_blocked, get_blocked_slot\n    if is_slot_blocked(date_str, period):\n        blocked_info = get_blocked_slot(date_str, period)\n        reason = blocked_info.get('reason', 'Beratung') if blocked_info else 'Beratung'\n        flash(f'Dieser Slot ist für {reason} blockiert und kann nicht gebucht werden.', 'error')\n        return redirect(url_for('dashboard', date=date_str))\n    \n    # Prüfe Zeitfenster\n    can_book, time_message = check_booking_time(booking_date, period)\n    if not can_book:\n        flash(time_message or 'Buchung nicht möglich.', 'error')\n        return redirect(url_for('dashboard', date=date_str))\n    \n    if request.method == 'POST':\n        # Hole Lehrkraft-Informationen\n        teacher_name = request.form.get('teacher_name', '').strip()\n        teacher_class = request.form.get('teacher_class', '').strip()\n        \n        if not teacher_name or not teacher_class:\n            flash('Bitte geben Sie Ihren Namen und Ihre Klasse ein.', 'error')\n            return render_template('book.html', \n                                 date_str=date_str,\n                                 period=period,\n                                 period_info=period_info,\n                                 period_time=PERIOD_TIMES[period],\n                                 available_spots=available_spots,\n                                 free_modules=FREE_MODULES)\n        \n        # Hole Anzahl der Schüler\n        num_students = int(request.form.get('num_students', 1))\n        \n        if num_students < 1 or num_students > 5:\n            flash('Bitte wählen Sie zwischen 1 und 5 Schülern.', 'error')\n            return render_template('book.html', \n                                 date_str=date_str,\n                                 period=period,\n                                 period_info=period_info,\n                                 period_time=PERIOD_TIMES[period],\n                                 available_spots=available_spots,\n                                 free_modules=FREE_MODULES)\n        \n        # Prüfe erneut verfügbare Plätze\n        if num_students > available_spots:\n            flash(f'Nicht genug Plätze verfügbar. Nur noch {available_spots} Plätze frei.', 'error')\n            return redirect(url_for('dashboard', date=date_str))\n        \n        # Sammle Schülerdaten und prüfe Doppelbuchungen\n        students = []\n        for i in range(num_students):\n            name = request.form.get(f'student_name_{i}', '').strip()\n            klasse = request.form.get(f'student_class_{i}', '').strip()\n            \n            if not name or not klasse:\n                flash('Bitte füllen Sie alle Schülerfelder aus.', 'error')\n                return render_template('book.html', \n                                     date_str=date_str,\n                                     period=period,\n                                     period_info=period_info,\n                                     period_time=PERIOD_TIMES[period],\n                                     available_spots=available_spots,\n                                     free_modules=FREE_MODULES)\n            \n            # Prüfe auf Doppelbuchung\n            double_booking = check_student_double_booking(name, klasse, date_str, period)\n            if double_booking['is_booked']:\n                flash(f'⚠️ Doppelbuchung verhindert: {double_booking[\"booking_info\"]}', 'error')\n                return render_template('book.html', \n                                     date_str=date_str,\n                                     period=period,\n                                     period_info=period_info,\n                                     period_time=PERIOD_TIMES[period],\n                                     available_spots=available_spots,\n                                     free_modules=FREE_MODULES)\n            \n            students.append({'name': name, 'klasse': klasse})\n        \n        # Hole Modul-Wahl (nur bei freien Stunden)\n        if period_info['type'] == 'frei':\n            selected_module = request.form.get('module', '')\n            if selected_module not in FREE_MODULES:\n                flash('Bitte wählen Sie ein Modul.', 'error')\n                return render_template('book.html', \n                                     date_str=date_str,\n                                     period=period,\n                                     period_info=period_info,\n                                     period_time=PERIOD_TIMES[period],\n                                     available_spots=available_spots,\n                                     free_modules=FREE_MODULES)\n            offer_label = selected_module\n        else:\n            offer_label = period_info['label']\n        \n        # Erstelle Buchung in Datenbank\n        booking_id = create_booking(\n            date=date_str,\n            weekday=weekday,\n            period=period,\n            teacher_id=session['user_id'],\n            students=students,\n            offer_type=period_info['type'],\n            offer_label=offer_label,\n            teacher_name=teacher_name,\n            teacher_class=teacher_class\n        )\n        \n        if booking_id:\n            # Erstelle Google Calendar Eintrag (wenn aktiviert)\n            calendar_event_id = None\n            if is_calendar_enabled():\n                try:\n                    calendar_data = {\n                        'date': date_str,\n                        'period': period,\n                        'teacher_name': teacher_name,\n                        'teacher_class': teacher_class,\n                        'students': students,\n                        'offer_label': offer_label\n                    }\n                    calendar_result = create_booking_event(calendar_data)\n                    if calendar_result['success']:\n                        calendar_event_id = calendar_result['event_id']\n                        # Update booking mit calendar_event_id\n                        booking = Booking.query.get(booking_id)\n                        if booking:\n                            booking.calendar_event_id = calendar_event_id\n                            db.session.commit()\n                        print(f\"✓ Google Calendar Eintrag erstellt: {calendar_result.get('event_link')}\")\n                    else:\n                        print(f\"⚠ Google Calendar Eintrag konnte nicht erstellt werden: {calendar_result.get('error')}\")\n                except Exception as e:\n                    print(f\"⚠ Fehler beim Erstellen des Calendar Eintrags: {e}\")\n            \n            # Sende E-Mail-Benachrichtigung\n            booking_data = {\n                'date': date_str,\n                'weekday': weekday,\n                'period': period,\n                'students': students,\n                'offer_type': period_info['type'],\n                'offer_label': offer_label,\n                'teacher_name': teacher_name,\n                'teacher_class': teacher_class,\n                'students_json': json.dumps(students, ensure_ascii=False)\n            }\n            # Erstelle Notification in der Datenbank\n            notification_message = f\"Neue Buchung: {teacher_name} hat {len(students)} Schüler für {offer_label} am {date_str} (Stunde {period}) angemeldet.\"\n            notification_id = create_notification(\n                booking_id=booking_id,\n                message=notification_message,\n                notification_type='new_booking',\n                recipient_role='admin',\n                metadata={\n                    'teacher_name': teacher_name,\n                    'teacher_class': teacher_class,\n                    'date': date_str,\n                    'period': period,\n                    'offer_label': offer_label,\n                    'students_count': len(students)\n                }\n            )\n            \n            # Sende E-Mail-Benachrichtigung an Admin (SMTP)\n            try:\n                send_booking_notification(booking_data)\n            except Exception as e:\n                print(f\"E-Mail-Benachrichtigung fehlgeschlagen: {e}\")\n            \n            # Broadcast an SSE-Clients\n            if notification_id:\n                unread_count = get_unread_notification_count(recipient_role='admin')\n                broadcast_notification({\n                    'type': 'new_booking',\n                    'notification_id': notification_id,\n                    'message': notification_message,\n                    'booking_data': {\n                        'date': date_str,\n                        'period': period,\n                        'teacher_name': teacher_name,\n                        'offer_label': offer_label,\n                        'students_count': len(students)\n                    },\n                    'unread_count': unread_count\n                })\n            \n            flash(f'Buchung erfolgreich! {len(students)} Schüler für {offer_label} angemeldet.', 'success')\n            return redirect(url_for('dashboard', date=date_str))\n        else:\n            flash('Fehler beim Erstellen der Buchung.', 'error')\n    \n    return render_template('book.html',\n                         date_str=date_str,\n                         period=period,\n                         period_info=period_info,\n                         period_time=PERIOD_TIMES[period],\n                         available_spots=available_spots,\n                         free_modules=FREE_MODULES)\n\n# Route: Admin-Bereich\n@app.route('/admin', methods=['GET', 'POST'])\n@admin_required\ndef admin():\n    \"\"\"Admin-Seite für Benutzerverwaltung und Buchungsübersicht\"\"\"\n    \n    if request.method == 'POST':\n        # Neue Lehrkraft anlegen\n        username = request.form.get('username', '').strip()\n        password = request.form.get('password', '')\n        email = request.form.get('email', '').strip()\n        \n        if not username or not password:\n            flash('Bitte füllen Sie alle Felder aus.', 'error')\n        else:\n            user_id = create_user(username, password, 'teacher', email if email else None)\n            if user_id:\n                flash(f'Lehrkraft {username} erfolgreich angelegt.', 'success')\n            else:\n                flash('Benutzername existiert bereits.', 'error')\n    \n    # Hole alle Benutzer\n    users = get_all_users()\n    \n    # Hole alle Buchungen\n    filter_date = request.args.get('filter_date', '')\n    if filter_date:\n        bookings = get_bookings_by_date(filter_date)\n    else:\n        bookings = get_all_bookings()\n    \n    # Konvertiere Buchungen für Anzeige\n    bookings_display = []\n    for booking in bookings:\n        booking_dict = dict(booking)\n        students = json.loads(booking_dict['students_json']) if booking_dict.get('students_json') else []\n        bookings_display.append({\n            'id': booking_dict['id'],\n            'date': booking_dict['date'],\n            'weekday': booking_dict['weekday'],\n            'period': booking_dict['period'],\n            'teacher_email': booking_dict['teacher_email'],\n            'teacher_name': booking_dict.get('teacher_name', 'N/A'),\n            'teacher_class': booking_dict.get('teacher_class', 'N/A'),\n            'offer_label': booking_dict['offer_label'],\n            'offer_type': booking_dict['offer_type'],\n            'students': students,\n            'student_count': len(students)\n        })\n    \n    return render_template('admin.html',\n                         users=users,\n                         bookings=bookings_display,\n                         filter_date=filter_date)\n\n# Route: Buchung erstellen (nur Admin)\n@app.route('/admin/create_booking', methods=['GET', 'POST'])\n@admin_required\ndef admin_create_booking():\n    \"\"\"Admin kann Buchungen für beliebige Lehrkräfte erstellen\"\"\"\n    from models import get_booking_by_id\n    \n    if request.method == 'POST':\n        date_str = request.form.get('date', '').strip()\n        \n        try:\n            period = int(request.form.get('period', 1))\n            teacher_id = int(request.form.get('teacher_id', 0))\n            num_students = int(request.form.get('num_students', 1))\n        except (ValueError, TypeError):\n            flash('Ungültige Eingabe für Stunde, Lehrkraft oder Schüleranzahl.', 'error')\n            users = get_all_users()\n            return render_template('admin_edit_booking.html',\n                                 booking=None,\n                                 users=users,\n                                 free_modules=FREE_MODULES,\n                                 period_times=PERIOD_TIMES)\n        \n        teacher_name = request.form.get('teacher_name', '').strip()\n        teacher_class = request.form.get('teacher_class', '').strip()\n        \n        if not date_str or not teacher_id or not teacher_name or not teacher_class or num_students < 1 or num_students > 5:\n            flash('Bitte füllen Sie alle Pflichtfelder aus und wählen Sie 1-5 Schüler.', 'error')\n            users = get_all_users()\n            return render_template('admin_edit_booking.html',\n                                 booking=None,\n                                 users=users,\n                                 free_modules=FREE_MODULES,\n                                 period_times=PERIOD_TIMES)\n        \n        try:\n            booking_date = datetime.strptime(date_str, '%Y-%m-%d').date()\n        except:\n            flash('Ungültiges Datum.', 'error')\n            users = get_all_users()\n            return render_template('admin_edit_booking.html',\n                                 booking=None,\n                                 users=users,\n                                 free_modules=FREE_MODULES,\n                                 period_times=PERIOD_TIMES)\n        \n        weekday = booking_date.strftime('%a')\n        period_info = get_period_info(weekday, period)\n        \n        # Prüfe Kapazität vor dem Erstellen der Buchung\n        current_students = count_students_for_period(date_str, period)\n        available_spots = MAX_STUDENTS_PER_PERIOD - current_students\n        \n        if num_students > available_spots:\n            flash(f'Nicht genug Plätze verfügbar. Nur noch {available_spots} Plätze frei.', 'error')\n            users = get_all_users()\n            return render_template('admin_edit_booking.html',\n                                 booking=None,\n                                 users=users,\n                                 free_modules=FREE_MODULES,\n                                 period_times=PERIOD_TIMES)\n        \n        students = []\n        for i in range(num_students):\n            name = request.form.get(f'student_name_{i}', '').strip()\n            klasse = request.form.get(f'student_class_{i}', '').strip()\n            \n            if not name or not klasse:\n                flash('Bitte füllen Sie alle Schülerfelder aus.', 'error')\n                users = get_all_users()\n                return render_template('admin_edit_booking.html',\n                                     booking=None,\n                                     users=users,\n                                     free_modules=FREE_MODULES,\n                                     period_times=PERIOD_TIMES)\n            \n            students.append({'name': name, 'klasse': klasse})\n        \n        if period_info['type'] == 'frei':\n            selected_module = request.form.get('module', '')\n            if selected_module not in FREE_MODULES:\n                flash('Bitte wählen Sie ein Modul.', 'error')\n                users = get_all_users()\n                return render_template('admin_edit_booking.html',\n                                     booking=None,\n                                     users=users,\n                                     free_modules=FREE_MODULES,\n                                     period_times=PERIOD_TIMES)\n            offer_label = selected_module\n        else:\n            offer_label = period_info['label']\n        \n        booking_id = create_booking(\n            date=date_str,\n            weekday=weekday,\n            period=period,\n            teacher_id=teacher_id,\n            students=students,\n            offer_type=period_info['type'],\n            offer_label=offer_label,\n            teacher_name=teacher_name,\n            teacher_class=teacher_class\n        )\n        \n        if booking_id:\n            flash(f'Buchung erfolgreich erstellt! {len(students)} Schüler für {offer_label} angemeldet.', 'success')\n            return redirect(url_for('admin'))\n        else:\n            flash('Fehler beim Erstellen der Buchung.', 'error')\n    \n    users = get_all_users()\n    return render_template('admin_edit_booking.html',\n                         booking=None,\n                         users=users,\n                         free_modules=FREE_MODULES,\n                         period_times=PERIOD_TIMES)\n\n# Route: Buchung bearbeiten (nur Admin)\n@app.route('/admin/edit_booking/<int:booking_id>', methods=['GET', 'POST'])\n@admin_required\ndef admin_edit_booking(booking_id):\n    \"\"\"Admin kann bestehende Buchungen bearbeiten\"\"\"\n    from models import get_booking_by_id, update_booking\n    \n    booking_row = get_booking_by_id(booking_id)\n    if not booking_row:\n        flash('Buchung nicht gefunden.', 'error')\n        return redirect(url_for('admin'))\n    \n    booking = dict(booking_row)\n    \n    if request.method == 'POST':\n        date_str = request.form.get('date', '').strip()\n        \n        try:\n            period = int(request.form.get('period', 1))\n            teacher_id = int(request.form.get('teacher_id', 0))\n            num_students = int(request.form.get('num_students', 1))\n        except (ValueError, TypeError):\n            flash('Ungültige Eingabe für Stunde, Lehrkraft oder Schüleranzahl.', 'error')\n            users = get_all_users()\n            students = json.loads(booking['students_json']) if booking.get('students_json') else []\n            booking_display = dict(booking)\n            booking_display['students'] = students\n            return render_template('admin_edit_booking.html',\n                                 booking=booking_display,\n                                 users=users,\n                                 free_modules=FREE_MODULES,\n                                 period_times=PERIOD_TIMES)\n        \n        teacher_name = request.form.get('teacher_name', '').strip()\n        teacher_class = request.form.get('teacher_class', '').strip()\n        \n        if not date_str or not teacher_id or not teacher_name or not teacher_class or num_students < 1 or num_students > 5:\n            flash('Bitte füllen Sie alle Pflichtfelder aus und wählen Sie 1-5 Schüler.', 'error')\n            users = get_all_users()\n            students = json.loads(booking['students_json']) if booking.get('students_json') else []\n            booking_display = dict(booking)\n            booking_display['students'] = students\n            return render_template('admin_edit_booking.html',\n                                 booking=booking_display,\n                                 users=users,\n                                 free_modules=FREE_MODULES,\n                                 period_times=PERIOD_TIMES)\n        \n        try:\n            booking_date = datetime.strptime(date_str, '%Y-%m-%d').date()\n        except:\n            flash('Ungültiges Datum.', 'error')\n            users = get_all_users()\n            students = json.loads(booking['students_json']) if booking.get('students_json') else []\n            booking_display = dict(booking)\n            booking_display['students'] = students\n            return render_template('admin_edit_booking.html',\n                                 booking=booking_display,\n                                 users=users,\n                                 free_modules=FREE_MODULES,\n                                 period_times=PERIOD_TIMES)\n        \n        weekday = booking_date.strftime('%a')\n        period_info = get_period_info(weekday, period)\n        \n        # Prüfe Kapazität: Berechne verfügbare Plätze ohne die aktuelle Buchung\n        current_students = count_students_for_period(date_str, period)\n        old_booking_students = len(json.loads(booking['students_json']) if booking.get('students_json') else [])\n        available_spots = MAX_STUDENTS_PER_PERIOD - (current_students - old_booking_students)\n        \n        if num_students > available_spots:\n            flash(f'Nicht genug Plätze verfügbar. Nur noch {available_spots} Plätze frei.', 'error')\n            users = get_all_users()\n            students = json.loads(booking['students_json']) if booking.get('students_json') else []\n            booking_display = dict(booking)\n            booking_display['students'] = students\n            return render_template('admin_edit_booking.html',\n                                 booking=booking_display,\n                                 users=users,\n                                 free_modules=FREE_MODULES,\n                                 period_times=PERIOD_TIMES)\n        \n        students = []\n        for i in range(num_students):\n            name = request.form.get(f'student_name_{i}', '').strip()\n            klasse = request.form.get(f'student_class_{i}', '').strip()\n            \n            if not name or not klasse:\n                flash('Bitte füllen Sie alle Schülerfelder aus.', 'error')\n                users = get_all_users()\n                students = json.loads(booking['students_json']) if booking.get('students_json') else []\n                booking_display = dict(booking)\n                booking_display['students'] = students\n                return render_template('admin_edit_booking.html',\n                                     booking=booking_display,\n                                     users=users,\n                                     free_modules=FREE_MODULES,\n                                     period_times=PERIOD_TIMES)\n            \n            students.append({'name': name, 'klasse': klasse})\n        \n        if period_info['type'] == 'frei':\n            selected_module = request.form.get('module', '')\n            if selected_module not in FREE_MODULES:\n                flash('Bitte wählen Sie ein Modul.', 'error')\n                users = get_all_users()\n                students = json.loads(booking['students_json']) if booking.get('students_json') else []\n                booking_display = dict(booking)\n                booking_display['students'] = students\n                return render_template('admin_edit_booking.html',\n                                     booking=booking_display,\n                                     users=users,\n                                     free_modules=FREE_MODULES,\n                                     period_times=PERIOD_TIMES)\n            offer_label = selected_module\n        else:\n            offer_label = period_info['label']\n        \n        if update_booking(\n            booking_id=booking_id,\n            date=date_str,\n            weekday=weekday,\n            period=period,\n            teacher_id=teacher_id,\n            students=students,\n            offer_type=period_info['type'],\n            offer_label=offer_label,\n            teacher_name=teacher_name,\n            teacher_class=teacher_class\n        ):\n            flash(f'Buchung erfolgreich aktualisiert!', 'success')\n            return redirect(url_for('admin'))\n        else:\n            flash('Fehler beim Aktualisieren der Buchung.', 'error')\n    \n    users = get_all_users()\n    students = json.loads(booking['students_json']) if booking.get('students_json') else []\n    booking_display = dict(booking)\n    booking_display['students'] = students\n    \n    return render_template('admin_edit_booking.html',\n                         booking=booking_display,\n                         users=users,\n                         free_modules=FREE_MODULES,\n                         period_times=PERIOD_TIMES)\n\n# Route: Buchung löschen (nur Admin)\n@app.route('/admin/delete_booking/<int:booking_id>', methods=['POST'])\n@admin_required\ndef delete_booking_route(booking_id):\n    \"\"\"Löscht eine Buchung\"\"\"\n    from models import delete_booking\n    \n    # Übergebe Calendar-Löschfunktion als Callback\n    if delete_booking(booking_id, delete_calendar_event_callback=delete_booking_event if is_calendar_enabled() else None):\n        flash('Buchung erfolgreich gelöscht.', 'success')\n    else:\n        flash('Buchung konnte nicht gelöscht werden.', 'error')\n    \n    return redirect(url_for('admin'))\n\n# Route: Slots verwalten (nur Admin)\n@app.route('/admin/manage_slots', methods=['GET', 'POST'])\n@admin_required\ndef manage_slots():\n    \"\"\"Admin kann feste Slot-Namen umbenennen\"\"\"\n    from models import update_slot_name\n    \n    if request.method == 'POST':\n        weekday = request.form.get('weekday')\n        period_str = request.form.get('period')\n        period = int(period_str) if period_str else 0\n        label = request.form.get('label', '').strip()\n        \n        if weekday and period and label:\n            if update_slot_name(weekday, period, label):\n                flash(f'Slot-Name erfolgreich aktualisiert!', 'success')\n            else:\n                flash('Fehler beim Aktualisieren des Slot-Namens.', 'error')\n        else:\n            flash('Bitte füllen Sie alle Felder aus.', 'error')\n        \n        return redirect(url_for('manage_slots'))\n    \n    fixed_slots = []\n    weekdays = {\n        'Mon': 'Montag',\n        'Tue': 'Dienstag', \n        'Wed': 'Mittwoch',\n        'Thu': 'Donnerstag',\n        'Fri': 'Freitag'\n    }\n    \n    for weekday_code, weekday_name in weekdays.items():\n        if weekday_code in FIXED_OFFERS:\n            for period, default_label in FIXED_OFFERS[weekday_code].items():\n                period_info = get_period_info(weekday_code, period)\n                fixed_slots.append({\n                    'weekday_code': weekday_code,\n                    'weekday_name': weekday_name,\n                    'period': period,\n                    'period_time': f\"{PERIOD_TIMES[period]['start']} - {PERIOD_TIMES[period]['end']}\",\n                    'default_label': default_label,\n                    'current_label': period_info['label']\n                })\n    \n    return render_template('admin_manage_slots.html', \n                         fixed_slots=fixed_slots)\n\n@app.route('/admin/block_slot', methods=['POST'])\n@admin_required\ndef admin_block_slot():\n    \"\"\"Admin blockiert einen Slot für Beratungsgespräche\"\"\"\n    from models import block_slot, is_slot_blocked\n    \n    # CSRF-Token Validierung\n    csrf_token = request.form.get('csrf_token', '')\n    if not validate_csrf_token(csrf_token):\n        flash('Ungültiges Sicherheits-Token. Bitte versuchen Sie es erneut.', 'error')\n        return redirect(request.referrer or url_for('dashboard'))\n    \n    date_str = request.form.get('date', '').strip()\n    period = request.form.get('period', type=int)\n    reason = request.form.get('reason', 'Beratung').strip()\n    \n    # Validiere Grund-Länge\n    if reason and len(reason) > 200:\n        reason = reason[:200]\n    \n    if not date_str or not period:\n        flash('Ungültige Slot-Daten.', 'error')\n        return redirect(request.referrer or url_for('dashboard'))\n    \n    try:\n        booking_date = datetime.strptime(date_str, '%Y-%m-%d').date()\n        weekday = booking_date.strftime('%a')\n    except:\n        flash('Ungültiges Datum.', 'error')\n        return redirect(request.referrer or url_for('dashboard'))\n    \n    if is_slot_blocked(date_str, period):\n        flash('Dieser Slot ist bereits blockiert.', 'warning')\n    else:\n        admin_id = session.get('user_id')\n        if block_slot(date_str, weekday, period, admin_id, reason):\n            flash(f'Slot erfolgreich für {reason} blockiert.', 'success')\n        else:\n            flash('Fehler beim Blockieren des Slots.', 'error')\n    \n    return redirect(request.referrer or url_for('dashboard'))\n\n@app.route('/admin/unblock_slot', methods=['POST'])\n@admin_required\ndef admin_unblock_slot():\n    \"\"\"Admin gibt einen blockierten Slot wieder frei\"\"\"\n    from models import unblock_slot\n    \n    # CSRF-Token Validierung\n    csrf_token = request.form.get('csrf_token', '')\n    if not validate_csrf_token(csrf_token):\n        flash('Ungültiges Sicherheits-Token. Bitte versuchen Sie es erneut.', 'error')\n        return redirect(request.referrer or url_for('dashboard'))\n    \n    date_str = request.form.get('date', '').strip()\n    period = request.form.get('period', type=int)\n    \n    if not date_str or not period:\n        flash('Ungültige Slot-Daten.', 'error')\n        return redirect(request.referrer or url_for('dashboard'))\n    \n    if unblock_slot(date_str, period):\n        flash('Slot erfolgreich freigegeben.', 'success')\n    else:\n        flash('Fehler beim Freigeben des Slots.', 'error')\n    \n    return redirect(request.referrer or url_for('dashboard'))\n\n# ============================================================================\n# Notifications & Server-Sent Events (SSE) Routes\n# ============================================================================\n\n# SSE deaktiviert - verursacht Worker-Timeouts in Produktion mit Gunicorn\n# @app.route('/notifications/stream')\n# @admin_required\n# def notifications_stream():\n#     \"\"\"SSE-Endpunkt für Echtzeit-Benachrichtigungen (nur für Admins)\"\"\"\n#     def event_stream():\n#         \"\"\"Generator für Server-Sent Events\"\"\"\n#         q = queue.Queue(maxsize=50)\n#         \n#         with subscribers_lock:\n#             notification_subscribers.append(q)\n#         \n#         try:\n#             while True:\n#                 try:\n#                     message = q.get(timeout=30)\n#                     yield f\"data: {json.dumps(message)}\\n\\n\"\n#                 except queue.Empty:\n#                     yield f\"data: {json.dumps({'type': 'ping'})}\\n\\n\"\n#         finally:\n#             with subscribers_lock:\n#                 if q in notification_subscribers:\n#                     notification_subscribers.remove(q)\n#     \n#     return Response(event_stream(), mimetype='text/event-stream')\n\n@app.route('/api/notifications/recent', methods=['GET'])\n@admin_required\ndef api_get_recent_notifications():\n    \"\"\"Holt die neuesten Benachrichtigungen\"\"\"\n    limit = request.args.get('limit', 10, type=int)\n    limit = min(limit, 50)\n    \n    notifications = get_recent_notifications(recipient_role='admin', limit=limit)\n    return jsonify({\n        'success': True,\n        'notifications': notifications\n    })\n\n@app.route('/api/notifications/unread_count', methods=['GET'])\n@admin_required\ndef api_get_unread_count():\n    \"\"\"Holt die Anzahl der ungelesenen Benachrichtigungen\"\"\"\n    count = get_unread_notification_count(recipient_role='admin')\n    return jsonify({\n        'success': True,\n        'count': count\n    })\n\n@app.route('/api/notifications/<int:notification_id>/mark_read', methods=['POST'])\n@admin_required\ndef api_mark_notification_read(notification_id):\n    \"\"\"Markiert eine Benachrichtigung als gelesen\"\"\"\n    csrf_token = request.json.get('csrf_token', '') if request.json else ''\n    if not validate_csrf_token(csrf_token):\n        return jsonify({\n            'success': False,\n            'error': 'Invalid CSRF token'\n        }), 403\n    \n    success = mark_notification_as_read(notification_id)\n    return jsonify({\n        'success': success\n    })\n\n@app.route('/api/notifications/mark_all_read', methods=['POST'])\n@admin_required\ndef api_mark_all_notifications_read():\n    \"\"\"Markiert alle Benachrichtigungen als gelesen\"\"\"\n    csrf_token = request.json.get('csrf_token', '') if request.json else ''\n    if not validate_csrf_token(csrf_token):\n        return jsonify({\n            'success': False,\n            'error': 'Invalid CSRF token'\n        }), 403\n    \n    success = mark_all_notifications_as_read(recipient_role='admin')\n    return jsonify({\n        'success': success\n    })\n\nif __name__ == '__main__':\n    # Starte die Anwendung\n    app.run(host='0.0.0.0', port=5000, debug=True)\n","size_bytes":54036},"pyproject.toml":{"content":"[project]\nname = \"repl-nix-workspace\"\nversion = \"0.1.0\"\ndescription = \"Add your description here\"\nrequires-python = \">=3.11\"\ndependencies = [\n    \"email-validator>=2.3.0\",\n    \"flask>=3.1.2\",\n    \"flask-sqlalchemy>=3.1.1\",\n    \"gunicorn>=23.0.0\",\n    \"psycopg2-binary>=2.9.11\",\n    \"pytz>=2025.2\",\n    \"werkzeug>=3.1.3\",\n]\n","size_bytes":323},"email_service.py":{"content":"import os\nimport smtplib\nimport json\nfrom email.mime.text import MIMEText\nfrom email.mime.multipart import MIMEMultipart\nfrom datetime import datetime\nfrom config import SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS, SMTP_FROM, ADMIN_EMAIL\n\n\ndef send_email_smtp(to_email, subject, body_html, body_text=None):\n    \"\"\"Sendet E-Mail über SMTP\"\"\"\n    try:\n        if not SMTP_USER or not SMTP_PASS:\n            print(f\"WARNUNG: SMTP nicht konfiguriert - E-Mail an {to_email} wird nicht gesendet\")\n            print(f\"Betreff: {subject}\")\n            print(f\"Body: {body_text or body_html[:200]}\")\n            return False\n        \n        message = MIMEMultipart('alternative')\n        message['From'] = SMTP_FROM\n        message['To'] = to_email\n        message['Subject'] = subject\n        \n        if body_text:\n            part1 = MIMEText(body_text, 'plain', 'utf-8')\n            message.attach(part1)\n        \n        part2 = MIMEText(body_html, 'html', 'utf-8')\n        message.attach(part2)\n        \n        server = smtplib.SMTP(SMTP_HOST, SMTP_PORT, timeout=10)\n        server.starttls()\n        server.login(SMTP_USER, SMTP_PASS)\n        server.send_message(message)\n        server.quit()\n        \n        print(f\"E-Mail erfolgreich gesendet an {to_email}\")\n        return True\n        \n    except Exception as e:\n        print(f\"FEHLER beim E-Mail-Versand an {to_email}: {e}\")\n        return False\n\n\ndef create_booking_notification_email(booking_data):\n    \"\"\"Erstellt eine formatierte E-Mail für Buchungsbenachrichtigungen\"\"\"\n    teacher_name = booking_data.get('teacher_name', 'Unbekannt')\n    teacher_class = booking_data.get('teacher_class', '')\n    date = booking_data.get('date', '')\n    weekday = booking_data.get('weekday', '')\n    period = booking_data.get('period', '')\n    offer_label = booking_data.get('offer_label', '')\n    offer_type = booking_data.get('offer_type', '')\n    \n    students = []\n    try:\n        students_json = booking_data.get('students_json', '[]')\n        if isinstance(students_json, str):\n            students = json.loads(students_json)\n        else:\n            students = students_json\n    except:\n        students = []\n    \n    students_count = len(students)\n    \n    if students:\n        students_names = ', '.join([f\"{s['name']} ({s['klasse']})\" for s in students])\n        students_list_html = '<br>'.join([f\"• {s['name']} (Klasse {s['klasse']})\" for s in students])\n    else:\n        students_names = 'Keine Schüler angegeben'\n        students_list_html = 'Keine Schüler angegeben'\n    \n    subject = f\"📅 SportOase Buchung: {offer_label} am {date}\"\n    \n    body_html = f\"\"\"\n    <html>\n    <head>\n        <style>\n            body {{ font-family: Arial, sans-serif; line-height: 1.6; color: #333; }}\n            .container {{ max-width: 600px; margin: 0 auto; padding: 20px; }}\n            .header {{ background: linear-gradient(135deg, #38bdf8 0%, #3b82f6 100%); \n                       color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center; }}\n            .header h2 {{ margin: 0; }}\n            .content {{ background: #f8f9fa; padding: 20px; border-radius: 8px; }}\n            .info-row {{ margin: 10px 0; padding: 12px; background: white; border-radius: 4px; border-left: 4px solid #38bdf8; }}\n            .label {{ font-weight: bold; color: #38bdf8; }}\n            .students-section {{ margin-top: 15px; padding: 15px; background: white; border-radius: 4px; }}\n            .footer {{ margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd; \n                      text-align: center; color: #666; font-size: 12px; }}\n            .badge {{ background: #38bdf8; color: white; padding: 4px 10px; \n                     border-radius: 12px; font-size: 11px; margin-left: 8px; }}\n        </style>\n    </head>\n    <body>\n        <div class=\"container\">\n            <div class=\"header\">\n                <h2>🏫 SportOase - Neue Buchung</h2>\n            </div>\n            <div class=\"content\">\n                <div class=\"info-row\">\n                    <span class=\"label\">👤 Lehrkraft:</span> {teacher_name}\n                    {f' (Klasse {teacher_class})' if teacher_class else ''}\n                </div>\n                <div class=\"info-row\">\n                    <span class=\"label\">📅 Datum:</span> {date} ({weekday})\n                </div>\n                <div class=\"info-row\">\n                    <span class=\"label\">🕐 Stunde:</span> {period}. Stunde\n                </div>\n                <div class=\"info-row\">\n                    <span class=\"label\">📋 Angebot:</span> {offer_label}\n                    <span class=\"badge\">{offer_type.upper()}</span>\n                </div>\n                <div class=\"students-section\">\n                    <div><span class=\"label\">👥 Schüler ({students_count}):</span></div>\n                    <div style=\"margin-top: 10px; margin-left: 10px;\">\n                        {students_list_html}\n                    </div>\n                </div>\n            </div>\n            <div class=\"footer\">\n                <p>Diese Nachricht wurde automatisch vom SportOase Buchungssystem generiert.</p>\n                <p>Zeit: {datetime.now().strftime('%d.%m.%Y um %H:%M Uhr')}</p>\n            </div>\n        </div>\n    </body>\n    </html>\n    \"\"\"\n    \n    body_text = f\"\"\"\nSportOase - Neue Buchung\n\nLehrkraft: {teacher_name} {f'(Klasse {teacher_class})' if teacher_class else ''}\nDatum: {date} ({weekday})\nStunde: {period}. Stunde\nAngebot: {offer_label} ({offer_type.upper()})\n\nSchüler ({students_count}):\n{students_names}\n\nZeit: {datetime.now().strftime('%d.%m.%Y um %H:%M Uhr')}\n\n---\nDiese Nachricht wurde automatisch vom SportOase Buchungssystem generiert.\n    \"\"\"\n    \n    return subject, body_html, body_text\n\n\ndef send_booking_notification(booking_data, admin_email=None):\n    \"\"\"Sendet Buchungsbenachrichtigung an Admin\"\"\"\n    try:\n        if not admin_email:\n            admin_email = ADMIN_EMAIL\n        \n        subject, body_html, body_text = create_booking_notification_email(booking_data)\n        return send_email_smtp(admin_email, subject, body_html, body_text)\n        \n    except Exception as e:\n        print(f\"Fehler beim Senden der Buchungsbenachrichtigung: {e}\")\n        return False\n","size_bytes":6252},"static/style.css":{"content":"/* \n   SportOase Buchungssystem - Modern UI Design\n   Modernes, cleanes Design inspiriert von zeitgemäßen Web-Apps\n*/\n\n:root {\n    --primary: #38bdf8;\n    --primary-dark: #0ea5e9;\n    --primary-light: #e0f2fe;\n    --accent: #10B981;\n    --accent-warn: #F59E0B;\n    --text-primary: #0F172A;\n    --text-secondary: #64748B;\n    --text-tertiary: #94A3B8;\n    --bg-primary: #FFFFFF;\n    --bg-secondary: #F8FAFC;\n    --bg-tertiary: #F1F5F9;\n    --border: #E2E8F0;\n    --border-light: #F1F5F9;\n    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);\n    --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);\n    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);\n    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);\n    --radius-sm: 6px;\n    --radius: 8px;\n    --radius-lg: 12px;\n    --radius-xl: 16px;\n}\n\n* {\n    margin: 0;\n    padding: 0;\n    box-sizing: border-box;\n}\n\nbody {\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', 'Roboto', 'Helvetica Neue', Arial, sans-serif;\n    line-height: 1.5;\n    color: var(--text-primary);\n    background: var(--bg-secondary);\n    -webkit-font-smoothing: antialiased;\n    -moz-osx-font-smoothing: grayscale;\n}\n\n.container {\n    max-width: 1400px;\n    margin: 0 auto;\n    padding: 0 2rem;\n}\n\n/* Top Navigation - Modern Minimal */\n.top-nav {\n    background: var(--bg-primary);\n    border-bottom: 1px solid var(--border);\n    padding: 0.75rem 0;\n    backdrop-filter: blur(10px);\n    position: sticky;\n    top: 0;\n    z-index: 100;\n}\n\n.top-nav nav {\n    display: flex;\n    gap: 0.5rem;\n    justify-content: flex-end;\n    align-items: center;\n}\n\n.top-nav nav a {\n    color: var(--text-secondary);\n    text-decoration: none;\n    padding: 0.5rem 1rem;\n    border-radius: var(--radius);\n    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n    font-weight: 500;\n    font-size: 0.875rem;\n}\n\n.top-nav nav a:hover {\n    background: var(--bg-tertiary);\n    color: var(--text-primary);\n}\n\n/* Main Content */\nmain {\n    min-height: 85vh;\n    padding: 2rem 0;\n}\n\nh2 {\n    font-size: 1.875rem;\n    font-weight: 700;\n    margin-bottom: 0.5rem;\n    color: var(--text-primary);\n    letter-spacing: -0.025em;\n}\n\nh3 {\n    font-size: 1.25rem;\n    font-weight: 600;\n    margin: 1rem 0 0.75rem 0;\n    color: var(--text-primary);\n}\n\nh4 {\n    font-size: 1rem;\n    font-weight: 600;\n    margin: 0.75rem 0 0.5rem 0;\n    color: var(--text-primary);\n}\n\n/* Flash Messages - Modern */\n.messages {\n    margin-bottom: 1.5rem;\n}\n\n.message {\n    padding: 0.875rem 1rem;\n    margin-bottom: 0.75rem;\n    border-radius: var(--radius);\n    font-size: 0.875rem;\n    font-weight: 500;\n    border-left: 3px solid;\n    background: var(--bg-primary);\n}\n\n.message-success {\n    border-color: var(--accent);\n    color: var(--accent);\n    background: #F0FDF4;\n}\n\n.message-error {\n    border-color: #EF4444;\n    color: #DC2626;\n    background: #FEF2F2;\n}\n\n/* Login Page - Modern Centered Card */\n.login-container {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    min-height: 100vh;\n    background: linear-gradient(135deg, #7dd3fc 0%, #38bdf8 100%);\n    padding: 1rem;\n}\n\n.login-box {\n    background: var(--bg-primary);\n    border-radius: var(--radius-xl);\n    box-shadow: var(--shadow-lg);\n    padding: 2.5rem;\n    width: 100%;\n    max-width: 420px;\n}\n\n.login-logo {\n    text-align: center;\n    margin-bottom: 2rem;\n}\n\n.login-logo img {\n    width: 200px;\n    height: 200px;\n    border-radius: 50%;\n    box-shadow: var(--shadow-md);\n}\n\n.login-box h2 {\n    text-align: center;\n    font-size: 1.5rem;\n    margin-bottom: 2rem;\n    color: var(--text-primary);\n}\n\n/* Form Inputs - Modern */\n.form-group {\n    margin-bottom: 1.25rem;\n}\n\n.form-group label {\n    display: block;\n    margin-bottom: 0.5rem;\n    font-weight: 500;\n    font-size: 0.875rem;\n    color: var(--text-primary);\n}\n\n.form-group input,\n.form-group select,\n.form-group textarea {\n    width: 100%;\n    padding: 0.75rem;\n    border: 1px solid var(--border);\n    border-radius: var(--radius);\n    font-size: 0.875rem;\n    transition: all 0.2s;\n    background: var(--bg-primary);\n    color: var(--text-primary);\n}\n\n.form-group input:focus,\n.form-group select:focus,\n.form-group textarea:focus {\n    outline: none;\n    border-color: var(--primary);\n    box-shadow: 0 0 0 3px var(--primary-light);\n}\n\n/* Buttons - Modern Minimal */\n.btn, button[type=\"submit\"] {\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    padding: 0.625rem 1.25rem;\n    font-size: 0.875rem;\n    font-weight: 500;\n    border-radius: var(--radius);\n    border: none;\n    cursor: pointer;\n    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n    text-decoration: none;\n    gap: 0.5rem;\n}\n\n.btn-primary {\n    background: var(--primary);\n    color: white;\n}\n\n.btn-primary:hover {\n    background: var(--primary-dark);\n    transform: translateY(-1px);\n    box-shadow: var(--shadow-md);\n}\n\n.btn-secondary {\n    background: var(--bg-tertiary);\n    color: var(--text-primary);\n}\n\n.btn-secondary:hover {\n    background: var(--border);\n}\n\n.btn-success {\n    background: var(--accent);\n    color: white;\n}\n\n.btn-success:hover {\n    background: #059669;\n}\n\n.btn-block {\n    background: #EF4444;\n    color: white;\n    font-size: 0.75rem;\n    padding: 0.375rem 0.75rem;\n}\n\n.btn-block:hover {\n    background: #DC2626;\n}\n\n.btn-small {\n    font-size: 0.75rem;\n    padding: 0.375rem 0.75rem;\n}\n\n/* Dashboard Header */\n.dashboard-header {\n    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);\n    border-radius: var(--radius-lg);\n    padding: 2rem;\n    margin-bottom: 2rem;\n    box-shadow: var(--shadow-lg);\n    text-align: center;\n}\n\n.dashboard-title {\n    color: white;\n    font-size: 2rem;\n    font-weight: 700;\n    margin: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 0.75rem;\n}\n\n.title-icon {\n    font-size: 2.5rem;\n    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));\n}\n\n/* Week Title Styling */\n.week-title {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 0.75rem;\n    flex-wrap: wrap;\n    font-size: 1.5rem;\n    font-weight: 600;\n    color: var(--text-primary);\n}\n\n.week-icon {\n    font-size: 1.75rem;\n}\n\n.week-dates {\n    font-size: 0.875rem;\n    font-weight: 500;\n    color: var(--text-secondary);\n    background: var(--primary-light);\n    padding: 0.25rem 0.75rem;\n    border-radius: var(--radius);\n    margin-left: 0.5rem;\n}\n\n/* Dashboard */\n.dashboard {\n    max-width: 100%;\n}\n\n.dashboard > h2 {\n    margin-bottom: 2rem;\n}\n\n/* Date Selector - Modern */\n.date-selector {\n    background: var(--bg-primary);\n    padding: 1rem;\n    border-radius: var(--radius-lg);\n    margin-bottom: 1.5rem;\n    box-shadow: var(--shadow-sm);\n    border: 1px solid var(--border);\n}\n\n.date-selector form {\n    display: flex;\n    align-items: center;\n    gap: 0.75rem;\n}\n\n.date-selector label {\n    font-weight: 500;\n    font-size: 0.875rem;\n    color: var(--text-secondary);\n}\n\n.date-selector input {\n    padding: 0.5rem 0.75rem;\n    border: 1px solid var(--border);\n    border-radius: var(--radius);\n    font-size: 0.875rem;\n    background: var(--bg-primary);\n    cursor: pointer;\n    transition: all 0.2s;\n}\n\n.date-selector input:hover {\n    border-color: var(--primary);\n}\n\n/* Selected Date Info */\n.selected-date-info {\n    margin-bottom: 2rem;\n}\n\n.selected-date-info h3 {\n    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);\n    color: white;\n    padding: 1rem 1.5rem;\n    margin: 0;\n    border-radius: var(--radius-lg);\n    text-align: center;\n    font-size: 1.125rem;\n    font-weight: 600;\n    box-shadow: var(--shadow-md);\n}\n\n/* Week Overview - Modern Card */\n.week-overview {\n    background: var(--bg-primary);\n    padding: 1.5rem;\n    border-radius: var(--radius-xl);\n    box-shadow: var(--shadow-sm);\n    margin-bottom: 2rem;\n    border: 1px solid var(--border);\n}\n\n.week-header-with-nav {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    margin-bottom: 1.5rem;\n    padding-bottom: 1rem;\n    border-bottom: 1px solid var(--border-light);\n    gap: 1rem;\n}\n\n.week-header-with-nav h3 {\n    color: var(--text-primary);\n    font-size: 1rem;\n    font-weight: 600;\n    margin: 0;\n    padding: 0;\n    border: none;\n    flex: 1;\n    text-align: center;\n}\n\n.week-nav-arrow {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 36px;\n    height: 36px;\n    background: var(--bg-tertiary);\n    color: var(--text-secondary);\n    border-radius: var(--radius);\n    text-decoration: none;\n    transition: all 0.2s;\n    flex-shrink: 0;\n    border: 1px solid var(--border);\n}\n\n.week-nav-arrow:hover {\n    background: var(--primary);\n    color: white;\n    border-color: var(--primary);\n}\n\n.week-nav-arrow .arrow-icon {\n    font-size: 1rem;\n}\n\n/* Week Table - Modern Grid */\n.week-table {\n    width: 100%;\n    border-collapse: separate;\n    border-spacing: 0;\n    margin-top: 0;\n}\n\n.week-table th,\n.week-table td {\n    padding: 0.75rem;\n    text-align: center;\n    vertical-align: top;\n    border: 1px solid var(--border-light);\n}\n\n.week-table th {\n    background: var(--bg-tertiary);\n    color: var(--text-primary);\n    font-weight: 600;\n    font-size: 0.75rem;\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n    border-bottom: 2px solid var(--border);\n}\n\n.week-table th:first-child {\n    border-top-left-radius: var(--radius);\n}\n\n.week-table th:last-child {\n    border-top-right-radius: var(--radius);\n}\n\n.week-day-header {\n    display: flex;\n    flex-direction: column;\n    gap: 0.25rem;\n}\n\n.day-name {\n    font-size: 0.875rem;\n    font-weight: 700;\n    letter-spacing: 0.05em;\n}\n\n.day-date {\n    font-size: 0.75rem;\n    opacity: 0.7;\n    font-weight: 500;\n}\n\n.week-table td {\n    font-size: 0.8125rem;\n    background: var(--bg-primary);\n    transition: all 0.2s;\n}\n\n.week-table td:hover {\n    background: var(--bg-secondary);\n}\n\n/* Period Styles */\n.period-header {\n    font-weight: 600;\n    margin-bottom: 0.625rem;\n    padding: 0.5rem;\n    border-radius: var(--radius-sm);\n    font-size: 0.75rem;\n    text-align: center;\n}\n\n.period-fest .period-header {\n    background: #FEF3C7;\n    color: #92400E;\n}\n\n.period-frei .period-header {\n    background: #D1FAE5;\n    color: #065F46;\n}\n\n.period-blocked {\n    background: #FEE2E2 !important;\n}\n\n.period-blocked:hover {\n    background: #FECACA !important;\n}\n\n.blocked-header {\n    background: #FEE2E2;\n    color: #991B1B;\n    border: 1px solid #FCA5A5;\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    gap: 0.25rem;\n}\n\n.blocked-icon {\n    font-size: 1.5rem;\n    font-weight: bold;\n    color: #DC2626;\n}\n\n.period-past {\n    opacity: 0.5;\n    background: var(--bg-secondary) !important;\n}\n\n.slot-detail {\n    font-size: 0.6875rem;\n    font-weight: 400;\n    margin-top: 0.25rem;\n    opacity: 0.8;\n}\n\n/* Booking Info - Optimized */\n.booking-info {\n    margin-top: 0.5rem;\n    padding: 0.5rem;\n    background: var(--bg-secondary);\n    border-radius: var(--radius-sm);\n    font-size: 0.6875rem;\n    text-align: left;\n}\n\n.slot-stat {\n    font-weight: 600;\n    color: var(--text-secondary);\n    margin-bottom: 0.375rem;\n    text-align: center;\n}\n\n.booking-entry {\n    margin-top: 0.375rem;\n    padding-top: 0.375rem;\n    border-top: 1px solid var(--border-light);\n}\n\n.booking-entry:first-child {\n    margin-top: 0;\n    padding-top: 0;\n    border-top: none;\n}\n\n.booking-title {\n    font-weight: 600;\n    color: var(--text-primary);\n    margin-bottom: 0.25rem;\n}\n\n.student-name {\n    font-size: 0.6875rem;\n    color: var(--text-secondary);\n    margin-left: 0.5rem;\n}\n\n/* Slot Actions - All Buttons Equal Size */\n.slot-actions {\n    margin-top: 0.625rem;\n    display: flex;\n    flex-direction: column;\n    gap: 0.375rem;\n}\n\n.slot-actions form {\n    margin: 0;\n}\n\n.slot-btn {\n    display: block;\n    width: 100%;\n    padding: 0.5rem 0.75rem;\n    font-size: 0.6875rem;\n    font-weight: 600;\n    text-align: center;\n    border-radius: var(--radius-sm);\n    border: none;\n    cursor: pointer;\n    transition: all 0.2s;\n    text-decoration: none;\n}\n\n.slot-btn-primary {\n    background: var(--primary);\n    color: white;\n}\n\n.slot-btn-primary:hover {\n    background: var(--primary-dark);\n}\n\n.slot-btn-success {\n    background: var(--accent);\n    color: white;\n}\n\n.slot-btn-success:hover {\n    background: #059669;\n}\n\n.slot-btn-block {\n    background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);\n    color: white;\n    border: none;\n    box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);\n    display: inline-flex;\n    align-items: center;\n    gap: 0.375rem;\n    font-weight: 500;\n}\n\n.slot-btn-block:hover {\n    background: linear-gradient(135deg, #D97706 0%, #B45309 100%);\n    transform: translateY(-1px);\n    box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);\n}\n\n.btn-icon {\n    font-size: 1rem;\n    display: inline-block;\n}\n\n.slot-btn-disabled {\n    background: var(--bg-tertiary);\n    color: var(--text-tertiary);\n    cursor: not-allowed;\n}\n\n/* Day Schedule - Modern Table */\n.day-schedule {\n    background: var(--bg-primary);\n    padding: 1.5rem;\n    border-radius: var(--radius-xl);\n    box-shadow: var(--shadow-sm);\n    border: 1px solid var(--border);\n}\n\n.day-schedule h3 {\n    margin-bottom: 1.25rem;\n    font-size: 1.125rem;\n}\n\n.schedule-table {\n    width: 100%;\n    border-collapse: separate;\n    border-spacing: 0;\n}\n\n.schedule-table th,\n.schedule-table td {\n    padding: 0.875rem;\n    text-align: left;\n    border-bottom: 1px solid var(--border-light);\n}\n\n.schedule-table th {\n    background: var(--bg-tertiary);\n    color: var(--text-secondary);\n    font-weight: 600;\n    font-size: 0.75rem;\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n}\n\n.schedule-table tbody tr:hover {\n    background: var(--bg-secondary);\n}\n\n.schedule-table tbody tr:last-child td {\n    border-bottom: none;\n}\n\n.blocked-row {\n    background: #FEF2F2 !important;\n}\n\n.past-row {\n    opacity: 0.5;\n}\n\n.unbookable-row {\n    opacity: 0.6;\n    background: var(--bg-tertiary) !important;\n    pointer-events: none;\n}\n\n.unbookable-row td {\n    color: var(--text-tertiary);\n}\n\n.weekend-row {\n    opacity: 0.5;\n    background: #FEF3C7 !important;\n}\n\n.time-restricted-row {\n    opacity: 0.65;\n    background: #FEF3C7 !important;\n}\n\n.capacity {\n    display: inline-block;\n    padding: 0.25rem 0.625rem;\n    background: var(--bg-tertiary);\n    border-radius: var(--radius-sm);\n    font-size: 0.8125rem;\n    font-weight: 500;\n}\n\n.capacity.full {\n    background: #FEE2E2;\n    color: #991B1B;\n}\n\n.blocked-text {\n    color: #DC2626;\n    font-weight: 600;\n}\n\n.time-message {\n    color: var(--text-tertiary);\n    font-size: 0.75rem;\n    font-style: italic;\n    margin-top: 0.25rem;\n}\n\n/* Booking Form - Modern */\n.booking-form {\n    background: var(--bg-primary);\n    padding: 2rem;\n    border-radius: var(--radius-xl);\n    box-shadow: var(--shadow-sm);\n    border: 1px solid var(--border);\n    max-width: 600px;\n    margin: 0 auto;\n}\n\n.booking-info-box {\n    background: var(--bg-secondary);\n    padding: 1rem;\n    border-radius: var(--radius);\n    margin-bottom: 1.5rem;\n    border-left: 3px solid var(--primary);\n}\n\n.student-list {\n    list-style: none;\n    margin-bottom: 1.5rem;\n}\n\n.student-item {\n    display: flex;\n    gap: 0.75rem;\n    margin-bottom: 0.75rem;\n}\n\n.student-item input {\n    flex: 1;\n}\n\n.btn-remove {\n    padding: 0.5rem 0.75rem;\n    background: #FEE2E2;\n    color: #DC2626;\n    border: none;\n    border-radius: var(--radius);\n    cursor: pointer;\n    font-size: 0.875rem;\n    transition: all 0.2s;\n}\n\n.btn-remove:hover {\n    background: #FEF2F2;\n}\n\n.btn-add {\n    padding: 0.5rem 1rem;\n    background: var(--bg-tertiary);\n    color: var(--text-primary);\n    border: 1px dashed var(--border);\n    border-radius: var(--radius);\n    cursor: pointer;\n    font-size: 0.875rem;\n    font-weight: 500;\n    transition: all 0.2s;\n}\n\n.btn-add:hover {\n    border-color: var(--primary);\n    background: var(--primary-light);\n    color: var(--primary);\n}\n\n/* Admin Panel - Modern Layout */\n.admin-panel {\n    display: grid;\n    gap: 1.5rem;\n}\n\n.admin-section {\n    background: var(--bg-primary);\n    padding: 1.5rem;\n    border-radius: var(--radius-xl);\n    box-shadow: var(--shadow-sm);\n    border: 1px solid var(--border);\n}\n\n.admin-section h3 {\n    margin-bottom: 1.25rem;\n    padding-bottom: 0.75rem;\n    border-bottom: 1px solid var(--border-light);\n}\n\n.user-list,\n.booking-list {\n    list-style: none;\n}\n\n.user-item,\n.booking-item {\n    padding: 0.875rem;\n    border-bottom: 1px solid var(--border-light);\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n}\n\n.user-item:last-child,\n.booking-item:last-child {\n    border-bottom: none;\n}\n\n.user-item:hover,\n.booking-item:hover {\n    background: var(--bg-secondary);\n}\n\n.badge {\n    display: inline-block;\n    padding: 0.25rem 0.625rem;\n    border-radius: var(--radius-sm);\n    font-size: 0.75rem;\n    font-weight: 600;\n}\n\n.badge-admin {\n    background: #DBEAFE;\n    color: #1E40AF;\n}\n\n.badge-teacher {\n    background: #D1FAE5;\n    color: #065F46;\n}\n\n/* Filter Form */\n.filter-form {\n    display: flex;\n    gap: 0.75rem;\n    margin-bottom: 1.5rem;\n    align-items: flex-end;\n}\n\n/* Responsive - Mobile Optimierung */\n@media (max-width: 768px) {\n    /* Container & Spacing */\n    .container {\n        padding: 0 0.75rem;\n    }\n    \n    main {\n        padding: 1rem 0;\n    }\n    \n    /* Typography */\n    h2 {\n        font-size: 1.5rem;\n    }\n    \n    h3 {\n        font-size: 1.125rem;\n    }\n    \n    /* Login Page */\n    .login-container {\n        padding: 0.5rem;\n    }\n    \n    .login-box {\n        padding: 1.5rem 1rem;\n        max-width: 100%;\n    }\n    \n    .login-logo img {\n        width: 120px;\n        height: 120px;\n    }\n    \n    /* Navigation */\n    .top-nav {\n        padding: 0.5rem 0;\n    }\n    \n    .top-nav nav {\n        flex-wrap: wrap;\n        gap: 0.25rem;\n    }\n    \n    .top-nav nav a {\n        font-size: 0.8125rem;\n        padding: 0.4rem 0.75rem;\n    }\n    \n    /* Buttons - Größer für Touch */\n    .btn, button[type=\"submit\"] {\n        padding: 0.75rem 1rem;\n        font-size: 0.9375rem;\n        min-height: 44px;\n    }\n    \n    .btn-small {\n        padding: 0.5rem 0.75rem;\n        font-size: 0.8125rem;\n    }\n    \n    /* Form Inputs - Größer für Touch */\n    .form-group input,\n    .form-group select,\n    .form-group textarea {\n        padding: 0.875rem;\n        font-size: 1rem;\n        min-height: 44px;\n    }\n    \n    /* Date Selector */\n    .date-selector {\n        padding: 0.75rem;\n    }\n    \n    .date-selector form {\n        flex-direction: column;\n        gap: 0.5rem;\n    }\n    \n    .date-selector input {\n        width: 100%;\n    }\n    \n    /* Week Overview */\n    .week-overview {\n        padding: 0.75rem;\n        overflow-x: auto;\n        -webkit-overflow-scrolling: touch;\n    }\n    \n    .week-header-with-nav {\n        flex-wrap: nowrap;\n        gap: 0.5rem;\n        margin-bottom: 1rem;\n    }\n    \n    .week-header-with-nav h3 {\n        font-size: 0.75rem;\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n    }\n    \n    .week-nav-arrow {\n        width: 32px;\n        height: 32px;\n        min-width: 32px;\n    }\n    \n    /* Week Table - Horizontal Scroll */\n    .week-table {\n        min-width: 600px;\n        font-size: 0.6875rem;\n    }\n    \n    .week-table th,\n    .week-table td {\n        padding: 0.375rem 0.25rem;\n        font-size: 0.6875rem;\n    }\n    \n    .day-name {\n        font-size: 0.75rem;\n    }\n    \n    .day-date {\n        font-size: 0.6875rem;\n    }\n    \n    .period-header {\n        font-size: 0.6875rem;\n        padding: 0.375rem;\n        margin-bottom: 0.5rem;\n    }\n    \n    .booking-info {\n        font-size: 0.625rem;\n        padding: 0.375rem;\n        margin-top: 0.375rem;\n    }\n    \n    .slot-stat {\n        font-size: 0.625rem;\n        margin-bottom: 0.25rem;\n    }\n    \n    .booking-entry {\n        margin-top: 0.25rem;\n        padding-top: 0.25rem;\n    }\n    \n    .booking-title {\n        font-size: 0.625rem;\n    }\n    \n    .student-name {\n        font-size: 0.5625rem;\n    }\n    \n    .slot-actions {\n        gap: 0.25rem;\n        margin-top: 0.5rem;\n    }\n    \n    .slot-btn {\n        padding: 0.375rem 0.5rem;\n        font-size: 0.625rem;\n        min-height: 28px;\n    }\n    \n    /* Day Schedule */\n    .day-schedule {\n        padding: 1rem;\n        overflow-x: auto;\n        -webkit-overflow-scrolling: touch;\n    }\n    \n    .schedule-table {\n        min-width: 600px;\n        font-size: 0.8125rem;\n    }\n    \n    .schedule-table th,\n    .schedule-table td {\n        padding: 0.625rem 0.5rem;\n        font-size: 0.8125rem;\n    }\n    \n    /* Booking Form */\n    .booking-form {\n        padding: 1rem;\n    }\n    \n    .booking-info-box {\n        padding: 0.75rem;\n        margin-bottom: 1rem;\n    }\n    \n    .booking-info-box h3 {\n        font-size: 1rem;\n        margin-bottom: 0.75rem;\n    }\n    \n    .booking-info-box p {\n        font-size: 0.875rem;\n        margin-bottom: 0.5rem;\n    }\n    \n    .student-list {\n        margin-bottom: 1rem;\n    }\n    \n    .student-item {\n        margin-bottom: 0.75rem;\n    }\n    \n    /* Admin Panel */\n    .admin-section {\n        padding: 1rem;\n    }\n    \n    .user-item,\n    .booking-item {\n        padding: 0.75rem;\n        flex-direction: column;\n        align-items: flex-start;\n        gap: 0.5rem;\n    }\n    \n    /* Filter Form */\n    .filter-form {\n        flex-direction: column;\n        align-items: stretch;\n    }\n    \n    /* Selected Date Info */\n    .selected-date-info h3 {\n        font-size: 1rem;\n        padding: 0.75rem 1rem;\n    }\n    \n    /* Credits Button - Kleiner auf Mobile */\n    .credits-button {\n        width: 44px;\n        height: 44px;\n        bottom: 15px;\n        right: 15px;\n        font-size: 1.25rem;\n    }\n    \n    .credits-content {\n        width: 95%;\n        margin: 15% auto;\n        padding: 1.5rem;\n    }\n    \n    .credits-content h3 {\n        font-size: 1.25rem;\n        margin-bottom: 1rem;\n    }\n    \n    .credits-content p {\n        font-size: 0.875rem;\n    }\n    \n    .credits-close {\n        font-size: 1.75rem;\n        right: 1rem;\n        top: 1rem;\n    }\n    \n    /* Messages */\n    .messages {\n        margin-bottom: 1rem;\n    }\n    \n    .message {\n        padding: 0.75rem;\n        font-size: 0.8125rem;\n    }\n}\n\n/* Extra Small Devices */\n@media (max-width: 480px) {\n    .container {\n        padding: 0 0.5rem;\n    }\n    \n    h2 {\n        font-size: 1.25rem;\n    }\n    \n    .login-logo img {\n        width: 100px;\n        height: 100px;\n    }\n    \n    .week-header-with-nav h3 {\n        font-size: 0.6875rem;\n    }\n    \n    .week-nav-arrow {\n        width: 28px;\n        height: 28px;\n        min-width: 28px;\n    }\n    \n    .credits-button {\n        width: 40px;\n        height: 40px;\n        bottom: 10px;\n        right: 10px;\n        font-size: 1.125rem;\n    }\n}\n\n/* Credits Button */\n.credits-button {\n    position: fixed;\n    bottom: 20px;\n    right: 20px;\n    width: 50px;\n    height: 50px;\n    background: var(--primary);\n    color: white;\n    border-radius: 50%;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: 1.5rem;\n    font-weight: bold;\n    cursor: pointer;\n    box-shadow: var(--shadow-lg);\n    transition: all 0.3s ease;\n    z-index: 1000;\n}\n\n.credits-button:hover {\n    background: var(--primary-dark);\n    transform: scale(1.1);\n}\n\n/* Credits Modal */\n.credits-modal {\n    display: none;\n    position: fixed;\n    z-index: 1001;\n    left: 0;\n    top: 0;\n    width: 100%;\n    height: 100%;\n    background-color: rgba(0, 0, 0, 0.5);\n    backdrop-filter: blur(4px);\n}\n\n.credits-content {\n    background-color: var(--bg-primary);\n    margin: 10% auto;\n    padding: 2rem;\n    border-radius: var(--radius-xl);\n    box-shadow: var(--shadow-lg);\n    width: 90%;\n    max-width: 500px;\n    position: relative;\n}\n\n.credits-content h3 {\n    margin-top: 0;\n    margin-bottom: 1.5rem;\n    color: var(--text-primary);\n    font-size: 1.5rem;\n}\n\n.credits-content p {\n    margin-bottom: 1rem;\n    color: var(--text-secondary);\n    line-height: 1.6;\n}\n\n.credits-close {\n    position: absolute;\n    right: 1.5rem;\n    top: 1.5rem;\n    color: var(--text-tertiary);\n    font-size: 2rem;\n    font-weight: bold;\n    cursor: pointer;\n    transition: color 0.2s;\n}\n\n.credits-close:hover {\n    color: var(--text-primary);\n}\n\n/* Footer */\nfooter {\n    background: var(--bg-primary);\n    border-top: 1px solid var(--border);\n    padding: 2rem 0;\n    margin-top: 4rem;\n    text-align: center;\n    color: var(--text-tertiary);\n    font-size: 0.875rem;\n}\n\n/* Notification System Styles */\n.notification-container {\n    position: relative;\n    display: inline-block;\n    margin: 0 10px;\n}\n\n.notification-bell {\n    background: none;\n    border: none;\n    font-size: 1.5rem;\n    cursor: pointer;\n    position: relative;\n    padding: 5px;\n    transition: transform 0.2s ease;\n}\n\n.notification-bell:hover {\n    transform: scale(1.1);\n}\n\n.notification-badge {\n    position: absolute;\n    top: -5px;\n    right: -5px;\n    background: var(--danger);\n    color: white;\n    border-radius: 12px;\n    padding: 2px 6px;\n    font-size: 0.75rem;\n    font-weight: bold;\n    min-width: 18px;\n    text-align: center;\n}\n\n.notification-dropdown {\n    display: none;\n    position: absolute;\n    top: 100%;\n    right: 0;\n    background: var(--bg-primary);\n    border: 1px solid var(--border);\n    border-radius: var(--radius);\n    box-shadow: var(--shadow-lg);\n    min-width: 350px;\n    max-width: 400px;\n    max-height: 500px;\n    overflow: hidden;\n    z-index: 1000;\n    margin-top: 10px;\n}\n\n.notification-header {\n    padding: 1rem;\n    border-bottom: 1px solid var(--border);\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n}\n\n.notification-header h4 {\n    margin: 0;\n    font-size: 1rem;\n    color: var(--text-primary);\n}\n\n.mark-all-read {\n    background: none;\n    border: none;\n    color: var(--primary);\n    cursor: pointer;\n    font-size: 0.875rem;\n    padding: 4px 8px;\n    border-radius: var(--radius-sm);\n    transition: background 0.2s;\n}\n\n.mark-all-read:hover {\n    background: var(--bg-secondary);\n}\n\n.notification-list {\n    max-height: 400px;\n    overflow-y: auto;\n}\n\n.notification-item {\n    padding: 1rem;\n    border-bottom: 1px solid var(--border);\n    display: flex;\n    justify-content: space-between;\n    align-items: flex-start;\n    transition: background 0.2s;\n}\n\n.notification-item:hover {\n    background: var(--bg-secondary);\n}\n\n.notification-item.read {\n    opacity: 0.6;\n}\n\n.notification-content {\n    flex: 1;\n}\n\n.notification-message {\n    margin: 0 0 0.5rem 0;\n    color: var(--text-primary);\n    font-size: 0.875rem;\n    line-height: 1.5;\n}\n\n.notification-time {\n    color: var(--text-tertiary);\n    font-size: 0.75rem;\n}\n\n.mark-read-btn {\n    background: var(--primary);\n    color: white;\n    border: none;\n    border-radius: 50%;\n    width: 24px;\n    height: 24px;\n    cursor: pointer;\n    font-size: 0.875rem;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    transition: all 0.2s;\n    margin-left: 10px;\n    flex-shrink: 0;\n}\n\n.mark-read-btn:hover {\n    background: var(--primary-dark);\n    transform: scale(1.1);\n}\n\n.no-notifications {\n    padding: 2rem;\n    text-align: center;\n    color: var(--text-tertiary);\n    font-size: 0.875rem;\n}\n\n/* Kontakt-Information Box */\n.contact-info-box {\n    margin: 2rem auto;\n    max-width: 800px;\n    background: linear-gradient(135deg, var(--primary-light) 0%, #ffffff 100%);\n    border: 2px solid var(--primary);\n    border-radius: var(--radius-lg);\n    padding: 1.5rem 2rem;\n    box-shadow: var(--shadow-md);\n}\n\n.contact-content {\n    display: flex;\n    align-items: center;\n    gap: 1.5rem;\n}\n\n.contact-logo {\n    width: 80px;\n    height: 80px;\n    object-fit: contain;\n    flex-shrink: 0;\n}\n\n.contact-text {\n    flex: 1;\n}\n\n.contact-text p {\n    margin: 0;\n    color: var(--text-primary);\n    font-size: 1rem;\n    line-height: 1.6;\n}\n\n.contact-text strong {\n    color: var(--primary);\n    font-weight: 600;\n}\n\n/* Responsive: Mobile */\n@media (max-width: 480px) {\n    .contact-info-box {\n        padding: 1rem 1.25rem;\n        margin: 1.5rem 1rem;\n    }\n    \n    .contact-content {\n        flex-direction: column;\n        text-align: center;\n        gap: 1rem;\n    }\n    \n    .contact-logo {\n        width: 60px;\n        height: 60px;\n    }\n    \n    .contact-text p {\n        font-size: 0.9rem;\n    }\n}\n\n/* IServ SSO Login Styles */\n.login-separator {\n    margin: 1.5rem 0;\n    text-align: center;\n    position: relative;\n}\n\n.login-separator::before {\n    content: '';\n    position: absolute;\n    top: 50%;\n    left: 0;\n    right: 0;\n    height: 1px;\n    background: var(--border);\n}\n\n.login-separator span {\n    background: var(--bg-primary);\n    padding: 0 1rem;\n    position: relative;\n    color: var(--text-tertiary);\n    font-size: 0.875rem;\n    font-weight: 500;\n}\n\n.btn-iserv {\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    gap: 0.75rem;\n    width: 100%;\n    padding: 0.875rem 1.5rem;\n    background: linear-gradient(135deg, #4F46E5 0%, #6366F1 100%);\n    color: white;\n    text-decoration: none;\n    border-radius: var(--radius);\n    font-weight: 600;\n    font-size: 1rem;\n    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n    box-shadow: var(--shadow-sm);\n    border: none;\n    cursor: pointer;\n}\n\n.btn-iserv:hover {\n    background: linear-gradient(135deg, #4338CA 0%, #4F46E5 100%);\n    box-shadow: var(--shadow-md);\n    transform: translateY(-1px);\n}\n\n.btn-iserv:active {\n    transform: translateY(0);\n    box-shadow: var(--shadow-sm);\n}\n\n.btn-iserv svg {\n    flex-shrink: 0;\n}\n","size_bytes":29778},"replit.md":{"content":"# SportOase Buchungssystem\n\n## Overview\n\nSportOase Buchungssystem is a web-based booking management system designed for school sports facilities. It enables teachers to efficiently book time slots for students (1-5 per slot) and provides administrators with comprehensive tools for managing teachers and bookings. The system features a dynamic weekly schedule, capacity controls, and real-time email notifications for new bookings, ensuring smooth operation and effective resource allocation.\n\n## User Preferences\n\nPreferred communication style: Simple, everyday language.\n\n## System Architecture\n\n### Frontend\n\nThe frontend uses Jinja2 templates (Flask) for rendering, ensuring a consistent layout with a base template. The design features a simple black-and-white color scheme, is responsive for desktop and tablet devices, and avoids heavy JavaScript frameworks by using vanilla JS for dynamic elements. Key templates include login, dashboard (with a weekly overview), booking forms, and an admin panel.\n\n### Backend\n\nBuilt with Flask (Python 3.11), the backend implements session-based authentication, role-based access control (`@login_required`, `@admin_required`), and timezone-aware datetime handling (Europe/Berlin). The application structure separates concerns into `app.py` (routes), `config.py` (settings), `models.py` (database interaction), `email_service.py` (SMTP notifications), and `db_setup.py` (initialization). It features booking validation (60-minute advance, 5-student max), past date detection, dynamic module selection, and full CRUD operations for admin booking management with capacity awareness.\n\n### Data Storage\n\nThe system utilizes PostgreSQL (Neon-backed via Replit) with Flask-SQLAlchemy 3.1.1 for ORM. The schema includes `users` (credentials, roles, email), `bookings` (date, period, student data as JSON, offer type), `slot_names` (customizable names for fixed slots), and `blocked_slots` (admin-blocked time slots with reasons). Password hashing is handled by `werkzeug.security`.\n\n### Authentication & Authorization\n\n**Dual Authentication System**: The application supports both traditional password-based login and IServ SSO (Single Sign-On) via OAuth2/OpenID Connect.\n\n- **Traditional Login**: Password-based authentication with hashed passwords (`werkzeug.security`).\n- **IServ SSO**: OAuth2/OpenID Connect integration using Authlib library for seamless login through school IServ credentials.\n  - Admin role: morelli.maurizio@kgs-pattensen.de\n  - Teacher role: All other IServ users\n  - Users are identified by email across both authentication methods\n  - OAuth users are stored with `oauth_provider='iserv'` and unique `oauth_id`\n\n**Session Management**: Session-based authentication storing user ID, email, and role in Flask sessions. SESSION_SECRET environment variable is enforced for security (no fallback allowed).\n\n**Authorization**: Two roles are defined:\n- **Teachers**: Create bookings, view dashboard\n- **Admins**: Full teacher permissions plus user/booking management\n\n### UI/UX Decisions\n\nThe UI features a modern card-based booking form design with improved visual hierarchy, professional gradient backgrounds, and shadow effects. Past dates are visually greyed out, and blocked slots are distinctly marked. Admin panels include quick-links and modal-based editing for slot management. A real-time notification system with a bell icon, unread badge, dropdown menu, and sound alerts for new bookings enhances the admin experience.\n\n### Technical Implementations & Feature Specifications\n\n- **Past Date Protection**: Comprehensive backend validation and frontend visual cues prevent booking of past time slots.\n- **Modernized Booking Form**: Redesigned booking interface with a card-based layout, icons, and improved responsiveness.\n- **Admin Slot Blocking**: Admins can block/unblock time slots for special purposes, visually indicated on the dashboard.\n- **Interactive Week Overview**: Clickable slots in the weekly overview link directly to booking forms, showing availability.\n- **Admin Slot Name Management**: Admins can customize fixed slot names via a management interface, overriding `config.py` defaults.\n- **Real-Time Notification System**: Integrated with Gmail API for email notifications and Server-Sent Events (SSE) for live updates to the admin dashboard, including unread counts and sound alerts.\n- **CSRF Protection**: All POST requests are protected with CSRF tokens.\n- **IServ SSO Integration**: OAuth2/OpenID Connect implementation using Authlib for seamless login through school IServ server. Supports automatic role assignment based on email domain. See `ISERV_INTEGRATION_SETUP.md` for configuration details.\n\n## External Dependencies\n\n- **SMTP Email Service**: Configured via environment variables (`SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASS`, `SMTP_FROM`, `ADMIN_EMAIL`) for automated booking notifications. Admin email: `sportoase.kg@gmail.com`.\n- **Python Packages**:\n    - `Flask` (Web framework)\n    - `Flask-SQLAlchemy` (ORM)\n    - `psycopg2-binary` (PostgreSQL adapter)\n    - `gunicorn` (Production WSGI server)\n    - `pytz` (Timezone handling)\n    - `werkzeug` (Password hashing)\n    - `email-validator` (Email validation)\n    - `Authlib` (OAuth2/OpenID Connect for IServ SSO)\n    - `smtplib`, `email.mime` (Standard library for email)\n- **Database**: PostgreSQL (Neon-backed on Replit, deployed to Render). Schema includes OAuth fields (`oauth_provider`, `oauth_id`) for SSO support.\n- **Gmail API**: Used for enhanced email notifications through Replit's Gmail connector.\n- **IServ OAuth**: Requires configuration in IServ admin panel (`Verwaltung → System → Single-Sign-On`). Environment variables: `ISERV_BASE_URL`, `ISERV_CLIENT_ID`, `ISERV_CLIENT_SECRET`, `SESSION_SECRET`.","size_bytes":5777},"db_setup.py":{"content":"# Skript zur Initialisierung der PostgreSQL-Datenbank\n# Dieses Skript erstellt die Datenbank und legt einen Admin-Benutzer an\n\nimport os\nfrom app import app\nfrom models import create_user, get_user_by_username\nfrom database import db\n\ndef setup_database():\n    \"\"\"Initialisiert die Datenbank und erstellt einen Standard-Admin-Account\"\"\"\n    with app.app_context():\n        print(\"Erstelle Datenbank-Tabellen...\")\n        db.create_all()\n        print(\"Datenbank-Tabellen erfolgreich erstellt!\")\n        \n        # Prüfe, ob bereits ein Admin existiert\n        admin = get_user_by_username('sportoase')\n        if not admin:\n            # Erstelle Standard-Admin mit korrekter E-Mail\n            admin_id = create_user('sportoase', 'mauro123', 'admin', 'sportoase.kg@gmail.com')\n            if admin_id:\n                print(f\"\\nAdmin-Account erstellt:\")\n                print(f\"  Benutzername: sportoase\")\n                print(f\"  Passwort: mauro123\")\n                print(f\"  E-Mail: sportoase.kg@gmail.com\")\n            else:\n                print(\"\\nFehler: Admin-Account konnte nicht erstellt werden.\")\n        else:\n            print(\"\\nAdmin-Account existiert bereits.\")\n        \n        print(\"\\nDatenbank-Setup abgeschlossen!\")\n        print(\"Sie können sich jetzt mit den Admin-Zugangsdaten anmelden.\")\n\nif __name__ == '__main__':\n    setup_database()\n","size_bytes":1366},"config.py":{"content":"# Konfigurationsdatei für die SportOase-Anwendung\n# Diese Datei enthält alle wichtigen Einstellungen wie Stundenpläne und Zeitangaben\n\nimport os\n\n# Zeitplan der Schulstunden (Beginn und Ende jeder Stunde)\n# Format: \"HH:MM\" für Start und Ende\nPERIOD_TIMES = {\n    1: {\n        \"start\": \"07:50\",\n        \"end\": \"08:35\"\n    },\n    2: {\n        \"start\": \"08:35\",\n        \"end\": \"09:20\"\n    },\n    3: {\n        \"start\": \"09:40\",\n        \"end\": \"10:25\"\n    },\n    4: {\n        \"start\": \"10:25\",\n        \"end\": \"11:20\"\n    },\n    5: {\n        \"start\": \"11:40\",\n        \"end\": \"12:25\"\n    },\n    6: {\n        \"start\": \"12:25\",\n        \"end\": \"13:10\"\n    }\n}\n\n# Feste Angebote pro Wochentag und Stunde\n# \"Mon\" = Montag, \"Tue\" = Dienstag, etc.\n# Wenn eine Stunde hier nicht aufgeführt ist, ist sie FREI (Lehrkraft wählt Modul)\nFIXED_OFFERS = {\n    \"Mon\": {  # Montag\n        1: \"Wochenstart-Aktivierung\",\n        3: \"Konflikt-Reset & Deeskalation\",\n        5: \"Koordinationszirkel\"\n    },\n    \"Tue\": {  # Dienstag - alle Stunden frei\n    },\n    \"Wed\": {  # Mittwoch\n        1: \"Sozialtraining / Gruppenreset\",\n        3: \"Aktivierung Mini-Fitness\",\n        5: \"Motorik-Parcours\"\n    },\n    \"Thu\": {  # Donnerstag\n        2: \"Konflikt-Reset\",\n        5: \"Turnen + Balance\"\n    },\n    \"Fri\": {  # Freitag\n        2: \"Atem & Reflexion\",\n        4: \"Bodyscan Light\",\n        5: \"Ruhezone / Entspannung\"\n    }\n}\n\n# Module, die bei freien Stunden wählbar sind\nFREE_MODULES = [\n    \"Aktivierung\", \"Regulation / Entspannung\", \"Konflikt-Reset\",\n    \"Egal / flexibel\"\n]\n\n# Maximale Anzahl Schüler pro Stunde\nMAX_STUDENTS_PER_PERIOD = 5\n\n# Vorlaufzeit für Buchungen in Minuten\nBOOKING_ADVANCE_MINUTES = 60\n\n# SMTP-Konfiguration (aus Umgebungsvariablen)\nSMTP_HOST = os.environ.get('SMTP_HOST', 'smtp.gmail.com')\nSMTP_PORT = int(os.environ.get('SMTP_PORT', '587'))\nSMTP_USER = os.environ.get('SMTP_USER', 'sportoase.kgs@gmail.com')\nSMTP_PASS = os.environ.get('SMTP_PASS', 'Unhack85!$')\nSMTP_FROM = os.environ.get('SMTP_FROM', 'sportoase.kgs@gmail.com')\nADMIN_EMAIL = os.environ.get('ADMIN_EMAIL', 'sportoase.kgs@gmail.com')\n\n# Flask Session Secret (aus Umgebungsvariable)\nSECRET_KEY = os.environ.get('SESSION_SECRET',\n                            'dev-secret-key-change-in-production')\n\n# Datenbank-Konfiguration (PostgreSQL)\nDATABASE_URL = os.environ.get('DATABASE_URL',\n                              'postgresql://localhost/sportoase')\n","size_bytes":2423},"main.py":{"content":"from app import app\n","size_bytes":20},"database.py":{"content":"# Zentrale Datenbank-Konfiguration\n# Diese Datei stellt die gemeinsame SQLAlchemy-Instanz bereit\n\nfrom flask_sqlalchemy import SQLAlchemy\n\ndb = SQLAlchemy()\n","size_bytes":157},"DEPLOYMENT.md":{"content":"# Deployment Guide für Render\n\nDiese Anleitung beschreibt, wie Sie die SportOase-App auf Render deployen.\n\n## Voraussetzungen\n\n- GitHub Repository mit dem Code\n- Render Account (kostenlos verfügbar)\n\n## Schritt 1: PostgreSQL-Datenbank erstellen\n\n1. Gehen Sie zu [Render Dashboard](https://dashboard.render.com/)\n2. Klicken Sie auf **New +** → **PostgreSQL**\n3. Konfiguration:\n   - **Name**: `sportoase-db` (oder ein anderer Name)\n   - **Database**: Leer lassen (wird automatisch generiert)\n   - **User**: Leer lassen (wird automatisch generiert)\n   - **Region**: Wählen Sie die nächstgelegene Region\n   - **PostgreSQL Version**: 15 oder 16\n   - **Plan**: Free (läuft nach 90 Tagen ab, erfordert Backup/Neuaufbau)\n\n4. Klicken Sie auf **Create Database**\n5. Notieren Sie sich die **Internal Database URL** (wird später benötigt)\n6. **WICHTIG**: Ändern Sie `postgres://` zu `postgresql://` in der URL\n\n## Schritt 2: Web Service erstellen\n\n1. Klicken Sie auf **New +** → **Web Service**\n2. Verbinden Sie Ihr GitHub Repository\n3. Konfiguration:\n\n| Einstellung | Wert |\n|-------------|------|\n| **Name** | `sportoase-app` |\n| **Region** | Gleiche wie Datenbank |\n| **Branch** | `main` |\n| **Build Command** | `pip install -r requirements.txt` |\n| **Start Command** | `gunicorn app:app` |\n| **Plan** | Free |\n\n## Schritt 3: Umgebungsvariablen konfigurieren\n\nFügen Sie diese Umgebungsvariablen hinzu (unter **Environment**):\n\n| Variable | Wert | Beschreibung |\n|----------|------|--------------|\n| `DATABASE_URL` | Internal Database URL von PostgreSQL | **Wichtig**: `postgres://` zu `postgresql://` ändern! |\n| `SESSION_SECRET` | Ein zufälliger String | Für Flask Sessions (z.B. 32+ Zeichen) |\n| `PYTHON_VERSION` | `3.11` | Python-Version |\n| `SMTP_HOST` | SMTP-Server | Optional: Für E-Mail-Benachrichtigungen |\n| `SMTP_PORT` | `587` | Optional: SMTP Port |\n| `SMTP_USER` | Ihr SMTP Benutzername | Optional |\n| `SMTP_PASS` | Ihr SMTP Passwort | Optional |\n| `SMTP_FROM` | sportoase@sportoase.de | Optional: Absender-E-Mail |\n| `ADMIN_EMAIL` | sportoase.kg@gmail.com | Admin E-Mail für Benachrichtigungen |\n\n### Beispiel für SESSION_SECRET generieren:\n\n```python\nimport os\nprint(os.urandom(32).hex())\n```\n\n## Schritt 4: Datenbank initialisieren\n\n**WICHTIG**: Nach dem ersten Deployment MUSS die Datenbank initialisiert werden!\n\n1. Verbinden Sie sich mit der Render Shell (im Dashboard unter \"Shell\")\n2. Führen Sie aus:\n\n```bash\npython db_setup.py\n```\n\nDies erstellt:\n- Alle Datenbank-Tabellen\n- Den Admin-Account mit:\n  - **Benutzername**: sportoase\n  - **Passwort**: mauro123\n  - **E-Mail**: sportoase.kg@gmail.com\n\n**WICHTIG**: Ändern Sie das Passwort nach dem ersten Login!\n\n## Schritt 5: Deployment überprüfen\n\n1. Öffnen Sie die URL Ihrer App (z.B. `https://sportoase-app.onrender.com`)\n2. Melden Sie sich mit den Admin-Zugangsdaten an\n3. Prüfen Sie, ob alles funktioniert\n\n## E-Mail-Konfiguration (optional)\n\nFür E-Mail-Benachrichtigungen bei Buchungen können Sie einen SMTP-Service verwenden:\n\n### Gmail SMTP (für Tests):\n- Host: `smtp.gmail.com`\n- Port: `587`\n- User: Ihre Gmail-Adresse\n- Pass: App-spezifisches Passwort (nicht Ihr normales Passwort!)\n\n[Anleitung für Gmail App-Passwort](https://support.google.com/accounts/answer/185833)\n\n### Professionelle Services:\n- SendGrid (kostenlos bis 100 E-Mails/Tag)\n- Mailgun\n- Amazon SES\n\n## Wichtige Hinweise\n\n1. **Free Tier**: \n   - Web Service schläft nach 15 Min Inaktivität\n   - Erste Anfrage dauert 30-60s zum Aufwachen\n   - PostgreSQL läuft nach 90 Tagen ab (Backup erforderlich!)\n\n2. **Datenbank-Backup**:\n   ```bash\n   pg_dump DATABASE_URL > backup.sql\n   ```\n\n3. **Logs überwachen**:\n   - Render Dashboard → Ihre App → Logs\n   - Hilft bei der Fehlersuche\n\n4. **Updates deployen**:\n   - Pushen Sie zu GitHub\n   - Render deployt automatisch\n   - **Nach größeren Datenbank-Änderungen**: Führen Sie `python db_setup.py` erneut aus\n\n## Troubleshooting\n\n### App startet nicht:\n- Prüfen Sie die Logs in Render Dashboard\n- Stellen Sie sicher, dass `DATABASE_URL` mit `postgresql://` beginnt\n- Überprüfen Sie, ob alle Pakete in `requirements.txt` sind\n\n### Datenbank-Verbindungsfehler:\n- Verwenden Sie die **Internal Database URL** (nicht External)\n- Bestätigen Sie, dass die Datenbank \"Available\" ist\n- Prüfen Sie, ob Region von App und DB übereinstimmt\n- **Wichtig**: Haben Sie `python db_setup.py` ausgeführt?\n\n### \"Tabelle existiert nicht\" Fehler:\n- Sie haben vergessen, `python db_setup.py` auszuführen!\n- Verbinden Sie sich mit der Shell und führen Sie das Skript aus\n\n### E-Mails werden nicht gesendet:\n- Überprüfen Sie SMTP-Einstellungen in den Umgebungsvariablen\n- Testen Sie SMTP-Zugangsdaten lokal\n- Prüfen Sie, ob Port 587 erlaubt ist\n- Für Gmail: Verwenden Sie ein App-spezifisches Passwort\n\n## Lokale Entwicklung\n\nFür die lokale Entwicklung:\n\n1. Installieren Sie PostgreSQL lokal\n2. Erstellen Sie eine `.env` Datei:\n   ```\n   DATABASE_URL=postgresql://localhost:5432/sportoase_dev\n   SESSION_SECRET=dev-secret-key\n   ADMIN_EMAIL=sportoase.kg@gmail.com\n   ```\n3. Führen Sie aus:\n   ```bash\n   python db_setup.py\n   uv run python app.py\n   ```\n\n## Support\n\nBei Fragen zu Render: https://render.com/docs\n","size_bytes":5219},"FIXES_NOVEMBER_2025.md":{"content":"# Performance-Fixes November 2025\n\n## Problem\nDie SportOase-App hatte zwei kritische Probleme in der Produktionsumgebung (sportoase.app):\n\n1. **Worker Timeouts**: Die Seite war extrem langsam, und es gab regelmäßig Gunicorn Worker-Timeouts\n2. **E-Mails kamen nicht an**: Buchungsbenachrichtigungen wurden nicht versendet\n\n## Ursachen\n\n### 1. Server-Sent Events (SSE) mit Gunicorn\nDas Problem lag am SSE-Endpoint `/notifications/stream`, der für Echtzeit-Benachrichtigungen verwendet wurde. Gunicorn ist nicht für Long-Polling und Server-Sent Events optimiert und verursachte:\n- Worker-Timeouts nach 30 Sekunden\n- Blockierte Worker-Threads\n- Extrem langsame Seitenlade-Zeiten\n\n### 2. Gmail-Integration funktioniert nur in Replit\nDie Replit Gmail-Integration ist nur in der Replit-Entwicklungsumgebung verfügbar, nicht aber auf externen Deployments wie Render (sportoase.app).\n\n## Lösungen\n\n### 1. SSE deaktiviert → Polling-System implementiert\n- ✅ SSE-Endpoint (`/notifications/stream`) wurde deaktiviert\n- ✅ Frontend nutzt jetzt Polling (alle 30 Sekunden) statt SSE\n- ✅ Benachrichtigungen werden weiterhin angezeigt, nur ohne Echtzeit-Updates\n- ✅ Keine Worker-Timeouts mehr\n\n### 2. SMTP E-Mail-Service eingerichtet\n- ✅ Umstellung von Gmail-Integration auf Standard-SMTP\n- ✅ `SMTP_USER` und `SMTP_PASS` als Replit Secrets konfiguriert\n- ✅ E-Mails werden jetzt über Gmail SMTP verschickt\n- ✅ Funktioniert sowohl in Replit als auch in Produktion (Render)\n\n### 3. Deployment-Optimierung\n- ✅ Gunicorn Timeout auf 120 Sekunden erhöht\n- ✅ 2 Worker-Prozesse konfiguriert\n- ✅ `--reuse-port` für bessere Performance\n\n## Technische Details\n\n### Geänderte Dateien:\n1. **app.py**: SSE-Endpoint auskommentiert\n2. **email_service.py**: Neu geschrieben mit SMTP-only Logik\n3. **templates/base.html**: SSE durch Polling ersetzt\n4. **config.py**: SMTP-Credentials aus Secrets laden\n5. **.replit**: Deployment-Konfiguration optimiert\n\n### Neue Secrets (bereits konfiguriert):\n- `SMTP_USER`: Gmail-Adresse für E-Mail-Versand\n- `SMTP_PASS`: Gmail App-Passwort (16-stellig)\n\n## Ergebnis\n✅ **App läuft jetzt stabil und schnell**\n✅ **Keine Worker-Timeouts mehr**\n✅ **E-Mails werden zuverlässig versendet**\n✅ **Funktioniert sowohl in Replit als auch auf sportoase.app**\n\n## Hinweis für zukünftige Updates\nWenn Sie Echtzeit-Benachrichtigungen zurück möchten, sollten Sie:\n- Einen WebSocket-Server verwenden (statt SSE)\n- Oder einen separaten Event-Service (Redis + Socket.io)\n- Gunicorn ist nicht für Long-Polling geeignet\n\n---\nDatum: 15. November 2025\nStatus: ✅ Alle Probleme behoben\n","size_bytes":2611},"notification_service.py":{"content":"import os\nimport json\nimport base64\nfrom email.mime.text import MIMEText\nfrom email.mime.multipart import MIMEMultipart\nimport subprocess\nfrom datetime import datetime\n\ndef get_gmail_access_token():\n    \"\"\"Holt das Access Token von der Replit Gmail Integration\"\"\"\n    try:\n        hostname = os.environ.get('REPLIT_CONNECTORS_HOSTNAME')\n        x_replit_token = None\n        \n        if os.environ.get('REPL_IDENTITY'):\n            x_replit_token = 'repl ' + os.environ['REPL_IDENTITY']\n        elif os.environ.get('WEB_REPL_RENEWAL'):\n            x_replit_token = 'depl ' + os.environ['WEB_REPL_RENEWAL']\n        \n        if not x_replit_token or not hostname:\n            print(\"Gmail Integration nicht verfügbar - verwende Fallback SMTP\")\n            return None\n        \n        import requests\n        response = requests.get(\n            f'https://{hostname}/api/v2/connection?include_secrets=true&connector_names=google-mail',\n            headers={\n                'Accept': 'application/json',\n                'X_REPLIT_TOKEN': x_replit_token\n            }\n        )\n        \n        if response.status_code == 200:\n            data = response.json()\n            if data.get('items') and len(data['items']) > 0:\n                connection = data['items'][0]\n                access_token = connection.get('settings', {}).get('access_token') or \\\n                             connection.get('settings', {}).get('oauth', {}).get('credentials', {}).get('access_token')\n                return access_token\n        \n        return None\n    except Exception as e:\n        print(f\"Fehler beim Abrufen des Gmail Access Tokens: {e}\")\n        return None\n\ndef send_gmail_notification(to_email, subject, body_html, body_text=None):\n    \"\"\"Sendet eine Email-Benachrichtigung über Gmail API\"\"\"\n    try:\n        access_token = get_gmail_access_token()\n        \n        if not access_token:\n            print(\"WARNUNG: Kein Gmail Access Token verfügbar - Email wird nicht gesendet\")\n            print(\"Stellen Sie sicher, dass die Gmail-Integration eingerichtet ist\")\n            return False\n        \n        from google.auth.transport.requests import Request\n        from google.oauth2.credentials import Credentials\n        from googleapiclient.discovery import build\n        \n        creds = Credentials(token=access_token)\n        \n        service = build('gmail', 'v1', credentials=creds)\n        \n        message = MIMEMultipart('alternative')\n        message['To'] = to_email\n        message['From'] = 'me'\n        message['Subject'] = subject\n        \n        if body_text:\n            part1 = MIMEText(body_text, 'plain')\n            message.attach(part1)\n        \n        part2 = MIMEText(body_html, 'html')\n        message.attach(part2)\n        \n        raw_message = base64.urlsafe_b64encode(message.as_bytes()).decode('utf-8')\n        \n        send_message = service.users().messages().send(\n            userId='me',\n            body={'raw': raw_message}\n        ).execute()\n        \n        print(f\"Email erfolgreich gesendet an {to_email}: {send_message['id']}\")\n        return True\n        \n    except Exception as e:\n        print(f\"Fehler beim Senden der Gmail-Nachricht: {e}\")\n        return False\n\ndef create_booking_notification_email(booking_data):\n    \"\"\"Erstellt eine formatierte Email-Benachrichtigung für eine neue Buchung\"\"\"\n    teacher_name = booking_data.get('teacher_name', 'Unbekannt')\n    teacher_class = booking_data.get('teacher_class', '')\n    date = booking_data.get('date', '')\n    period = booking_data.get('period', '')\n    offer_label = booking_data.get('offer_label', '')\n    offer_type = booking_data.get('offer_type', '')\n    \n    students = []\n    try:\n        students_json = booking_data.get('students_json', '[]')\n        students = json.loads(students_json) if isinstance(students_json, str) else students_json\n    except:\n        students = []\n    \n    students_count = len(students)\n    \n    if students:\n        students_names = ', '.join([f\"{s['name']} ({s['klasse']})\" for s in students])\n    else:\n        students_names = 'Keine Schüler angegeben'\n    \n    subject = f\"📅 Neue Buchung: {offer_label} am {date}\"\n    \n    body_html = f\"\"\"\n    <html>\n    <head>\n        <style>\n            body {{ font-family: Arial, sans-serif; line-height: 1.6; color: #333; }}\n            .container {{ max-width: 600px; margin: 0 auto; padding: 20px; }}\n            .header {{ background: linear-gradient(135deg, #38bdf8 0%, #3b82f6 100%); \n                       color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }}\n            .header h2 {{ margin: 0; }}\n            .content {{ background: #f8f9fa; padding: 20px; border-radius: 8px; }}\n            .info-row {{ margin: 10px 0; padding: 10px; background: white; border-radius: 4px; }}\n            .label {{ font-weight: bold; color: #38bdf8; }}\n            .students-list {{ margin-top: 10px; padding-left: 20px; }}\n            .footer {{ margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd; \n                      text-align: center; color: #666; font-size: 12px; }}\n        </style>\n    </head>\n    <body>\n        <div class=\"container\">\n            <div class=\"header\">\n                <h2>🏫 SportOase - Neue Buchung</h2>\n            </div>\n            <div class=\"content\">\n                <div class=\"info-row\">\n                    <span class=\"label\">👤 Lehrkraft:</span> {teacher_name}\n                    {f' ({teacher_class})' if teacher_class else ''}\n                </div>\n                <div class=\"info-row\">\n                    <span class=\"label\">📅 Datum:</span> {date}\n                </div>\n                <div class=\"info-row\">\n                    <span class=\"label\">🕐 Stunde:</span> Stunde {period}\n                </div>\n                <div class=\"info-row\">\n                    <span class=\"label\">📋 Angebot:</span> {offer_label}\n                    <span style=\"background: {'#4ade80' if offer_type == 'fest' else '#60a5fa'}; \n                                 color: white; padding: 2px 8px; border-radius: 12px; \n                                 font-size: 11px; margin-left: 8px;\">\n                        {offer_type.upper()}\n                    </span>\n                </div>\n                <div class=\"info-row\">\n                    <span class=\"label\">👥 Anzahl Schüler:</span> {students_count}\n                    <div class=\"students-list\">\n                        {students_names}\n                    </div>\n                </div>\n            </div>\n            <div class=\"footer\">\n                <p>Diese Nachricht wurde automatisch vom SportOase Buchungssystem generiert.</p>\n                <p>Zeit: {datetime.now().strftime('%d.%m.%Y um %H:%M Uhr')}</p>\n            </div>\n        </div>\n    </body>\n    </html>\n    \"\"\"\n    \n    body_text = f\"\"\"\nSportOase - Neue Buchung\n\nLehrkraft: {teacher_name} {f'({teacher_class})' if teacher_class else ''}\nDatum: {date}\nStunde: Stunde {period}\nAngebot: {offer_label} ({offer_type.upper()})\nAnzahl Schüler: {students_count}\nSchüler: {students_names}\n\nZeit: {datetime.now().strftime('%d.%m.%Y um %H:%M Uhr')}\n    \"\"\"\n    \n    return subject, body_html, body_text\n\ndef send_booking_notification(booking_data, admin_email):\n    \"\"\"Sendet eine Buchungsbenachrichtigung an den Admin\"\"\"\n    try:\n        subject, body_html, body_text = create_booking_notification_email(booking_data)\n        return send_gmail_notification(admin_email, subject, body_html, body_text)\n    except Exception as e:\n        print(f\"Fehler beim Senden der Buchungsbenachrichtigung: {e}\")\n        return False\n","size_bytes":7606},"test_gmail.py":{"content":"#!/usr/bin/env python3\n\"\"\"Test-Skript für Gmail-Integration und Benachrichtigungen\"\"\"\n\nimport os\nfrom notification_service import send_gmail_notification, send_booking_notification\nfrom datetime import datetime\n\ndef test_simple_email():\n    \"\"\"Sendet eine einfache Test-Email\"\"\"\n    print(\"=\" * 50)\n    print(\"TEST 1: Einfache Test-Email\")\n    print(\"=\" * 50)\n    \n    admin_email = os.environ.get('ADMIN_EMAIL', 'sportoase.kg@gmail.com')\n    subject = \"✅ SportOase Gmail-Integration Test\"\n    \n    body_html = \"\"\"\n    <html>\n    <head>\n        <style>\n            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n            .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n            .header { background: linear-gradient(135deg, #38bdf8 0%, #3b82f6 100%); \n                     color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }\n            .content { background: #f8f9fa; padding: 20px; border-radius: 8px; }\n        </style>\n    </head>\n    <body>\n        <div class=\"container\">\n            <div class=\"header\">\n                <h2>🎉 Gmail-Integration erfolgreich!</h2>\n            </div>\n            <div class=\"content\">\n                <p>Die Gmail-Integration für das SportOase Buchungssystem wurde erfolgreich eingerichtet.</p>\n                <p><strong>Testzeit:</strong> \"\"\" + datetime.now().strftime('%d.%m.%Y um %H:%M Uhr') + \"\"\"</p>\n                <p>E-Mail-Benachrichtigungen funktionieren jetzt einwandfrei! ✅</p>\n            </div>\n        </div>\n    </body>\n    </html>\n    \"\"\"\n    \n    body_text = f\"\"\"\nSportOase - Gmail-Integration Test\n\nDie Gmail-Integration wurde erfolgreich eingerichtet.\nTestzeit: {datetime.now().strftime('%d.%m.%Y um %H:%M Uhr')}\n\nE-Mail-Benachrichtigungen funktionieren jetzt einwandfrei!\n    \"\"\"\n    \n    success = send_gmail_notification(admin_email, subject, body_html, body_text)\n    \n    if success:\n        print(f\"✅ Test-Email erfolgreich gesendet an {admin_email}\")\n    else:\n        print(f\"❌ Fehler beim Senden der Test-Email\")\n    \n    return success\n\ndef test_booking_notification():\n    \"\"\"Testet eine Buchungsbenachrichtigung\"\"\"\n    print(\"\\n\" + \"=\" * 50)\n    print(\"TEST 2: Buchungsbenachrichtigung\")\n    print(\"=\" * 50)\n    \n    admin_email = os.environ.get('ADMIN_EMAIL', 'sportoase.kg@gmail.com')\n    \n    # Simuliere Buchungsdaten\n    booking_data = {\n        'teacher_name': 'Max Mustermann',\n        'teacher_class': '5a',\n        'date': '2025-11-20',\n        'period': 3,\n        'offer_label': 'Basketball',\n        'offer_type': 'fest',\n        'students_json': '[{\"name\": \"Anna Schmidt\", \"klasse\": \"5a\"}, {\"name\": \"Tom Müller\", \"klasse\": \"5b\"}]'\n    }\n    \n    success = send_booking_notification(booking_data, admin_email)\n    \n    if success:\n        print(f\"✅ Buchungsbenachrichtigung erfolgreich gesendet an {admin_email}\")\n    else:\n        print(f\"❌ Fehler beim Senden der Buchungsbenachrichtigung\")\n    \n    return success\n\nif __name__ == '__main__':\n    print(\"\\n🔍 Starte Gmail-Integration Tests...\\n\")\n    \n    # Test 1: Einfache Email\n    test1_result = test_simple_email()\n    \n    # Test 2: Buchungsbenachrichtigung\n    test2_result = test_booking_notification()\n    \n    # Zusammenfassung\n    print(\"\\n\" + \"=\" * 50)\n    print(\"ZUSAMMENFASSUNG\")\n    print(\"=\" * 50)\n    print(f\"Test 1 (Einfache Email): {'✅ BESTANDEN' if test1_result else '❌ FEHLGESCHLAGEN'}\")\n    print(f\"Test 2 (Buchungsbenachrichtigung): {'✅ BESTANDEN' if test2_result else '❌ FEHLGESCHLAGEN'}\")\n    \n    if test1_result and test2_result:\n        print(\"\\n🎉 Alle Tests erfolgreich! Gmail-Integration funktioniert perfekt.\")\n    else:\n        print(\"\\n⚠️ Einige Tests sind fehlgeschlagen. Bitte Logs prüfen.\")\n","size_bytes":3762},"GOOGLE_CALENDAR_SETUP.md":{"content":"# Google Calendar Integration Setup\n\nDiese Anleitung erklärt, wie Sie die Google Calendar Integration für das SportOase Buchungssystem einrichten.\n\n## Schritt 1: Google Cloud Service Account erstellen\n\n1. Gehen Sie zur [Google Cloud Console](https://console.cloud.google.com/)\n2. Erstellen Sie ein neues Projekt oder wählen Sie ein bestehendes aus\n3. Aktivieren Sie die **Google Calendar API**:\n   - Navigieren Sie zu \"APIs & Services\" > \"Library\"\n   - Suchen Sie nach \"Google Calendar API\"\n   - Klicken Sie auf \"Enable\"\n\n## Schritt 2: Service Account erstellen\n\n1. Gehen Sie zu \"APIs & Services\" > \"Credentials\"\n2. Klicken Sie auf \"Create Credentials\" > \"Service Account\"\n3. Geben Sie einen Namen ein (z.B. \"sportoase-calendar\")\n4. Klicken Sie auf \"Create and Continue\"\n5. Überspringen Sie die optionalen Schritte und klicken Sie auf \"Done\"\n\n## Schritt 3: Service Account Key erstellen\n\n1. Klicken Sie auf den neu erstellten Service Account\n2. Gehen Sie zum Tab \"Keys\"\n3. Klicken Sie auf \"Add Key\" > \"Create new key\"\n4. Wählen Sie **JSON** als Schlüsseltyp\n5. Klicken Sie auf \"Create\"\n6. Eine JSON-Datei wird heruntergeladen - **bewahren Sie diese sicher auf!**\n\n## Schritt 4: Service Account Zugriff auf Calendar geben\n\n1. Öffnen Sie [Google Calendar](https://calendar.google.com/)\n2. Wählen Sie den Kalender aus, in dem die Buchungen erscheinen sollen\n3. Klicken Sie auf die drei Punkte neben dem Kalender > \"Settings and sharing\"\n4. Scrollen Sie zu \"Share with specific people\"\n5. Klicken Sie auf \"Add people\"\n6. Geben Sie die **Service Account E-Mail** ein (steht in der JSON-Datei als `client_email`)\n7. Wählen Sie die Berechtigung **\"Make changes to events\"**\n8. Klicken Sie auf \"Send\"\n\n## Schritt 5: Umgebungsvariablen konfigurieren\n\n### Für Replit:\n1. Öffnen Sie die **Secrets** in Replit (🔒 Icon in der Sidebar)\n2. Fügen Sie folgende Secrets hinzu:\n\n**GOOGLE_CALENDAR_CREDENTIALS**\n```\nDer komplette Inhalt der JSON-Datei als String\n```\n\n**GOOGLE_CALENDAR_ID** (optional)\n```\nprimary\n```\n(Oder die spezifische Calendar ID, wenn Sie einen anderen Kalender verwenden möchten)\n\n### Für Render / andere Umgebungen:\n1. Gehen Sie zu den Environment Variables\n2. Fügen Sie hinzu:\n   - **GOOGLE_CALENDAR_CREDENTIALS**: Kompletter JSON-Inhalt als String\n   - **GOOGLE_CALENDAR_ID**: `primary` (oder spezifische Calendar ID)\n\n## Schritt 6: Datenbank-Migration ausführen\n\nFühren Sie das Migrations-Script aus, um die `calendar_event_id` Spalte hinzuzufügen:\n\n```bash\npython migration_add_calendar_event_id.py\n```\n\n## Schritt 7: Anwendung neu starten\n\nStarten Sie die Anwendung neu, damit die Änderungen wirksam werden.\n\n## Testen\n\n1. Erstellen Sie eine neue Buchung über die Webseite\n2. Überprüfen Sie Ihren Google Calendar - es sollte ein neuer Eintrag erscheinen\n3. Die Logs sollten zeigen: `✓ Google Calendar Service erfolgreich initialisiert`\n\n## Fehlersuche\n\n### \"Google Calendar nicht konfiguriert\"\n- Überprüfen Sie, ob die `GOOGLE_CALENDAR_CREDENTIALS` Secret gesetzt ist\n- Stellen Sie sicher, dass es gültiges JSON ist\n\n### \"403 Forbidden\" Fehler\n- Überprüfen Sie, ob der Service Account Zugriff auf den Kalender hat\n- Stellen Sie sicher, dass die Google Calendar API aktiviert ist\n\n### Kalender-Einträge erscheinen nicht\n- Überprüfen Sie die `GOOGLE_CALENDAR_ID` (sollte `primary` sein für den Hauptkalender)\n- Prüfen Sie die Logs auf Fehlermeldungen\n\n## Hinweise\n\n- Die Calendar-Integration ist **optional** - die App funktioniert auch ohne sie\n- Wenn die Integration nicht konfiguriert ist, werden nur E-Mails versendet\n- Bei Buchungslöschungen wird automatisch auch der Calendar-Eintrag gelöscht\n- Jeder Calendar-Eintrag enthält:\n  - Titel: \"SportOase: [Angebot]\"\n  - Datum und Uhrzeit der Stunde\n  - Lehrkraft und Klasse\n  - Liste aller gebuchten Schüler\n  - Erinnerungen (1 Tag vorher, 1 Stunde vorher)\n","size_bytes":3857},"calendar_service.py":{"content":"\"\"\"\nGoogle Calendar Service für SportOase Buchungssystem\nErstellt automatisch Kalendereinträge bei Buchungen\n\"\"\"\n\nimport os\nimport json\nfrom datetime import datetime, timedelta\nfrom google.oauth2 import service_account\nfrom googleapiclient.discovery import build\nfrom googleapiclient.errors import HttpError\n\n# Globale Variablen für Calendar Service\n_calendar_service = None\n_calendar_enabled = False\n\ndef init_calendar_service():\n    \"\"\"\n    Initialisiert den Google Calendar Service mit Service Account Credentials\n    Gibt True zurück wenn erfolgreich, False wenn Kalender deaktiviert ist\n    \"\"\"\n    global _calendar_service, _calendar_enabled\n    \n    # Prüfe ob Google Calendar Credentials vorhanden sind\n    credentials_json = os.environ.get('GOOGLE_CALENDAR_CREDENTIALS')\n    \n    if not credentials_json:\n        print(\"INFO: Google Calendar nicht konfiguriert (GOOGLE_CALENDAR_CREDENTIALS fehlt)\")\n        _calendar_enabled = False\n        return False\n    \n    try:\n        # Parse die Service Account Credentials aus dem JSON String\n        credentials_info = json.loads(credentials_json)\n        \n        # Erstelle Credentials Objekt\n        credentials = service_account.Credentials.from_service_account_info(\n            credentials_info,\n            scopes=['https://www.googleapis.com/auth/calendar']\n        )\n        \n        # Erstelle Calendar Service\n        _calendar_service = build('calendar', 'v3', credentials=credentials)\n        _calendar_enabled = True\n        print(\"✓ Google Calendar Service erfolgreich initialisiert\")\n        return True\n        \n    except json.JSONDecodeError as e:\n        print(f\"FEHLER: Google Calendar Credentials sind kein gültiges JSON: {e}\")\n        _calendar_enabled = False\n        return False\n    except Exception as e:\n        print(f\"FEHLER: Google Calendar Service konnte nicht initialisiert werden: {e}\")\n        _calendar_enabled = False\n        return False\n\ndef is_calendar_enabled():\n    \"\"\"Gibt True zurück wenn Google Calendar aktiviert ist\"\"\"\n    return _calendar_enabled\n\ndef create_booking_event(booking_data):\n    \"\"\"\n    Erstellt einen Google Calendar Eintrag für eine Buchung\n    \n    Args:\n        booking_data: Dictionary mit Buchungsdaten\n            - date: Datum als String (YYYY-MM-DD)\n            - period: Stundennummer (1-6)\n            - teacher_name: Name der Lehrkraft\n            - teacher_class: Klasse der Lehrkraft\n            - students: Liste von Schülern [{'name': '...', 'class': '...'}, ...]\n            - offer_label: Label des Angebots\n    \n    Returns:\n        Dictionary mit 'success' (True/False) und 'event_id' oder 'error'\n    \"\"\"\n    global _calendar_service, _calendar_enabled\n    \n    # Wenn Calendar nicht aktiviert, gebe Warnung zurück\n    if not _calendar_enabled:\n        return {\n            'success': False,\n            'error': 'Google Calendar ist nicht konfiguriert'\n        }\n    \n    try:\n        from config import PERIOD_TIMES\n        \n        # Hole Zeitdaten für die Stunde\n        period = booking_data['period']\n        period_time = PERIOD_TIMES[period]\n        \n        # Erstelle Start- und End-Datetime\n        booking_date = datetime.strptime(booking_data['date'], '%Y-%m-%d')\n        \n        # Parse Start- und Endzeit\n        start_hour, start_minute = map(int, period_time['start'].split(':'))\n        end_hour, end_minute = map(int, period_time['end'].split(':'))\n        \n        start_datetime = booking_date.replace(hour=start_hour, minute=start_minute)\n        end_datetime = booking_date.replace(hour=end_hour, minute=end_minute)\n        \n        # Formatiere für Google Calendar (ISO 8601)\n        start_time = start_datetime.isoformat()\n        end_time = end_datetime.isoformat()\n        \n        # Erstelle Schülerliste für Beschreibung\n        students_list = '\\n'.join([\n            f\"  • {s['name']} ({s.get('klasse', s.get('class', 'N/A'))})\" \n            for s in booking_data['students']\n        ])\n        \n        # Erstelle Event\n        event = {\n            'summary': f\"SportOase: {booking_data['offer_label']}\",\n            'description': f\"\"\"SportOase Buchung\n            \nLehrkraft: {booking_data['teacher_name']} ({booking_data['teacher_class']})\nAngebot: {booking_data['offer_label']}\nStunde: {period}. Stunde ({period_time['start']} - {period_time['end']})\n\nSchüler ({len(booking_data['students'])}):\n{students_list}\n\n--- \nErstellt durch SportOase Buchungssystem\n\"\"\",\n            'start': {\n                'dateTime': start_time,\n                'timeZone': 'Europe/Berlin',\n            },\n            'end': {\n                'dateTime': end_time,\n                'timeZone': 'Europe/Berlin',\n            },\n            'reminders': {\n                'useDefault': False,\n                'overrides': [\n                    {'method': 'email', 'minutes': 24 * 60},  # 1 Tag vorher\n                    {'method': 'popup', 'minutes': 60},       # 1 Stunde vorher\n                ],\n            },\n        }\n        \n        # Hole Calendar ID aus Umgebungsvariablen (default: primary)\n        calendar_id = os.environ.get('GOOGLE_CALENDAR_ID', 'primary')\n        \n        # Erstelle Event in Google Calendar\n        created_event = _calendar_service.events().insert(\n            calendarId=calendar_id,\n            body=event\n        ).execute()\n        \n        print(f\"✓ Google Calendar Eintrag erstellt: {created_event.get('htmlLink')}\")\n        \n        return {\n            'success': True,\n            'event_id': created_event['id'],\n            'event_link': created_event.get('htmlLink')\n        }\n        \n    except HttpError as error:\n        error_msg = f\"Google Calendar API Fehler: {error}\"\n        print(f\"FEHLER: {error_msg}\")\n        return {\n            'success': False,\n            'error': error_msg\n        }\n    except Exception as e:\n        error_msg = f\"Fehler beim Erstellen des Calendar Eintrags: {e}\"\n        print(f\"FEHLER: {error_msg}\")\n        return {\n            'success': False,\n            'error': error_msg\n        }\n\ndef delete_booking_event(event_id):\n    \"\"\"\n    Löscht einen Google Calendar Eintrag\n    \n    Args:\n        event_id: Die Google Calendar Event ID\n    \n    Returns:\n        Dictionary mit 'success' (True/False) und optional 'error'\n    \"\"\"\n    global _calendar_service, _calendar_enabled\n    \n    if not _calendar_enabled:\n        return {\n            'success': False,\n            'error': 'Google Calendar ist nicht konfiguriert'\n        }\n    \n    if not event_id:\n        return {\n            'success': False,\n            'error': 'Keine Event ID angegeben'\n        }\n    \n    try:\n        calendar_id = os.environ.get('GOOGLE_CALENDAR_ID', 'primary')\n        \n        _calendar_service.events().delete(\n            calendarId=calendar_id,\n            eventId=event_id\n        ).execute()\n        \n        print(f\"✓ Google Calendar Eintrag gelöscht: {event_id}\")\n        \n        return {'success': True}\n        \n    except HttpError as error:\n        error_msg = f\"Google Calendar API Fehler: {error}\"\n        print(f\"FEHLER: {error_msg}\")\n        return {\n            'success': False,\n            'error': error_msg\n        }\n    except Exception as e:\n        error_msg = f\"Fehler beim Löschen des Calendar Eintrags: {e}\"\n        print(f\"FEHLER: {error_msg}\")\n        return {\n            'success': False,\n            'error': error_msg\n        }\n","size_bytes":7408},"migration_add_oauth_fields.py":{"content":"# Datenbank-Migration: Fügt OAuth-Felder zur users-Tabelle hinzu\n# Führe dieses Skript einmalig aus, um die Datenbank zu aktualisieren\n\nfrom app import app, db\n\ndef add_oauth_fields():\n    \"\"\"Fügt oauth_provider und oauth_id Felder zur users-Tabelle hinzu\"\"\"\n    with app.app_context():\n        try:\n            # ALTER TABLE mit PostgreSQL\n            db.session.execute(db.text('''\n                ALTER TABLE users \n                ADD COLUMN IF NOT EXISTS oauth_provider VARCHAR(50),\n                ADD COLUMN IF NOT EXISTS oauth_id VARCHAR(200)\n            '''))\n            \n            # Password_hash nullable machen\n            db.session.execute(db.text('''\n                ALTER TABLE users \n                ALTER COLUMN password_hash DROP NOT NULL\n            '''))\n            \n            # Unique Constraint hinzufügen\n            db.session.execute(db.text('''\n                ALTER TABLE users \n                ADD CONSTRAINT unique_oauth_user \n                UNIQUE (oauth_provider, oauth_id)\n            '''))\n            \n            # Index auf email hinzufügen falls noch nicht vorhanden\n            db.session.execute(db.text('''\n                CREATE INDEX IF NOT EXISTS ix_users_email ON users(email)\n            '''))\n            \n            db.session.commit()\n            print(\"✅ OAuth-Felder erfolgreich zur users-Tabelle hinzugefügt!\")\n            print(\"   - oauth_provider VARCHAR(50)\")\n            print(\"   - oauth_id VARCHAR(200)\")\n            print(\"   - password_hash ist jetzt nullable\")\n            print(\"   - Unique Constraint auf (oauth_provider, oauth_id)\")\n            print(\"   - Index auf email-Feld\")\n            \n        except Exception as e:\n            db.session.rollback()\n            print(f\"❌ Fehler bei der Migration: {e}\")\n            print(\"Hinweis: Wenn Felder bereits existieren, ist das normal.\")\n\nif __name__ == '__main__':\n    print(\"Starte OAuth-Felder Migration...\")\n    add_oauth_fields()\n","size_bytes":1970},"oauth_config.py":{"content":"# IServ OAuth2/OpenID Connect Konfiguration für SportOase\n# Diese Datei konfiguriert die SSO-Integration mit IServ\n\nimport os\nfrom authlib.integrations.flask_client import OAuth\n\ndef init_oauth(app):\n    \"\"\"Initialisiert OAuth2 mit IServ-Konfiguration\"\"\"\n    oauth = OAuth(app)\n    \n    # IServ-Instanz-Domain aus Umgebungsvariablen\n    iserv_domain = os.environ.get('ISERV_DOMAIN', 'kgs-pattensen.de')\n    iserv_base_url = f'https://{iserv_domain}'\n    \n    # Registriere IServ als OAuth-Provider\n    iserv = oauth.register(\n        name='iserv',\n        client_id=os.environ.get('ISERV_CLIENT_ID'),\n        client_secret=os.environ.get('ISERV_CLIENT_SECRET'),\n        server_metadata_url=f'{iserv_base_url}/.well-known/openid-configuration',\n        client_kwargs={\n            'scope': 'openid profile email'\n        }\n    )\n    \n    return oauth, iserv\n\ndef get_admin_email():\n    \"\"\"Gibt die E-Mail-Adresse des Admin-Benutzers zurück\"\"\"\n    return 'morelli.maurizio@kgs-pattensen.de'\n\ndef is_admin_email(email):\n    \"\"\"Prüft, ob die E-Mail-Adresse dem Admin gehört\"\"\"\n    return email and email.lower().strip() == get_admin_email().lower()\n\ndef determine_user_role(userinfo):\n    \"\"\"\n    Bestimmt die Rolle des Benutzers basierend auf IServ-Daten\n    \n    Args:\n        userinfo: Dictionary mit Benutzerdaten von IServ (email, name, groups, etc.)\n    \n    Returns:\n        'admin' oder 'teacher'\n    \"\"\"\n    email = userinfo.get('email', '').lower().strip()\n    \n    # morelli.maurizio@kgs-pattensen.de ist Admin\n    if is_admin_email(email):\n        return 'admin'\n    \n    # Alle anderen sind normale Lehrer\n    return 'teacher'\n","size_bytes":1640},"migration_add_calendar_event_id.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nMigrations-Script: Fügt calendar_event_id Spalte zur bookings Tabelle hinzu\n\nDieses Script erweitert die bookings Tabelle um die calendar_event_id Spalte,\ndie für die Google Calendar Integration benötigt wird.\n\"\"\"\n\nimport os\nimport psycopg2\nfrom urllib.parse import urlparse\n\ndef add_calendar_event_id_column():\n    \"\"\"Fügt die calendar_event_id Spalte zur bookings Tabelle hinzu\"\"\"\n    \n    # Hole DATABASE_URL\n    database_url = os.environ.get('DATABASE_URL')\n    if not database_url:\n        print(\"FEHLER: DATABASE_URL Umgebungsvariable nicht gesetzt!\")\n        return False\n    \n    try:\n        # Verbinde zur Datenbank\n        conn = psycopg2.connect(database_url)\n        cursor = conn.cursor()\n        \n        print(\"Verbunden mit der Datenbank...\")\n        \n        # Prüfe ob Spalte bereits existiert\n        cursor.execute(\"\"\"\n            SELECT column_name \n            FROM information_schema.columns \n            WHERE table_name='bookings' AND column_name='calendar_event_id';\n        \"\"\")\n        \n        if cursor.fetchone():\n            print(\"✓ Spalte 'calendar_event_id' existiert bereits - keine Migration nötig\")\n            cursor.close()\n            conn.close()\n            return True\n        \n        # Füge Spalte hinzu\n        print(\"Füge Spalte 'calendar_event_id' zur Tabelle 'bookings' hinzu...\")\n        cursor.execute(\"\"\"\n            ALTER TABLE bookings \n            ADD COLUMN calendar_event_id VARCHAR(200);\n        \"\"\")\n        \n        conn.commit()\n        print(\"✓ Migration erfolgreich abgeschlossen!\")\n        print(\"  - Spalte 'calendar_event_id' wurde zur Tabelle 'bookings' hinzugefügt\")\n        \n        cursor.close()\n        conn.close()\n        return True\n        \n    except Exception as e:\n        print(f\"FEHLER bei der Migration: {e}\")\n        return False\n\nif __name__ == '__main__':\n    print(\"=\" * 60)\n    print(\"SportOase - Datenbank Migration\")\n    print(\"Fügt calendar_event_id Spalte hinzu\")\n    print(\"=\" * 60)\n    print()\n    \n    success = add_calendar_event_id_column()\n    \n    print()\n    if success:\n        print(\"✓ Migration erfolgreich abgeschlossen!\")\n    else:\n        print(\"✗ Migration fehlgeschlagen - bitte Fehler überprüfen\")\n    print(\"=\" * 60)\n","size_bytes":2275},"ISERV_INTEGRATION_SETUP.md":{"content":"# IServ SSO Integration - Setup-Anleitung für SportOase\n\nDiese Anleitung beschreibt, wie Sie die SportOase-App mit IServ SSO (Single Sign-On) verbinden.\n\n## Übersicht\n\nDie SportOase-App unterstützt **OAuth2/OpenID Connect** für die Authentifizierung über IServ. Damit können sich Lehrkräfte mit ihrem IServ-Account anmelden, ohne ein separates Passwort für SportOase zu benötigen.\n\n### Rollenverwaltung\n\n- **Admin**: `morelli.maurizio@kgs-pattensen.de` erhält automatisch Admin-Rechte\n- **Lehrer**: Alle anderen IServ-Benutzer erhalten normale Lehrkraft-Rechte (keine Admin-Funktionen)\n\n## Schritt 1: IServ-Admin-Konfiguration\n\n### 1.1 Neue OAuth-Anwendung registrieren\n\nDer IServ-Administrator muss folgende Schritte durchführen:\n\n1. In IServ einloggen als Administrator\n2. Navigieren zu: **Verwaltung → System → Single-Sign-On**\n3. Klicken auf **\"Hinzufügen\"**\n\n### 1.2 Allgemeine Einstellungen\n\nFolgende Daten eingeben:\n\n| Feld | Wert |\n|------|------|\n| **Name** | SportOase Buchungssystem |\n| **Beschreibung** | Buchungssystem für die SportOase-Anmeldungen |\n| **Vertrauenswürdig** | ✅ Ja (Haken setzen) |\n\n**Wichtig**: Nach dem Speichern werden automatisch generiert:\n- **Client-ID** (z.B. `sportoase_1234567`)\n- **Client-Secret** (z.B. `a1b2c3d4...xyz`)\n\n➡️ **Diese Werte notieren und sicher aufbewahren!**\n\n### 1.3 Redirect URIs konfigurieren\n\nIn der OAuth-Konfiguration unter \"Anwendung\" folgende Callback-URL eintragen:\n\n**Für Replit:**\n```\nhttps://sportoase.app/oauth/callback\n```\n\n**Für andere Domains:**\n```\nhttps://IHR_DOMAIN/oauth/callback\n```\n\n### 1.4 Scopes\n\nStandardmäßig benötigte Scopes (automatisch konfiguriert):\n- `openid` - Grundlegende Authentifizierung\n- `profile` - Name des Benutzers\n- `email` - E-Mail-Adresse\n\n### 1.5 Benutzerrechte\n\nSicherstellen, dass die gewünschten Benutzer/Gruppen die Berechtigung **\"OAuth verwenden\"** haben:\n\n1. Navigieren zu: **Verwaltung → Benutzer**\n2. Benutzer/Gruppe auswählen\n3. Unter \"Rechte\" → **\"OAuth verwenden\"** aktivieren\n\n## Schritt 2: SportOase-App Konfiguration (Replit)\n\n### 2.1 Umgebungsvariablen setzen\n\nIn Replit → **Secrets** (Schloss-Symbol) folgende Werte hinzufügen:\n\n| Secret-Name | Wert | Beschreibung |\n|-------------|------|--------------|\n| `ISERV_DOMAIN` | `kgs-pattensen.de` | IServ-Instanz-Domain (ohne https://) |\n| `ISERV_CLIENT_ID` | `[Client-ID von IServ]` | Von IServ generierte Client-ID |\n| `ISERV_CLIENT_SECRET` | `[Client-Secret von IServ]` | Von IServ generiertes Client-Secret |\n\n### 2.2 Beispiel\n\n```\nISERV_DOMAIN=kgs-pattensen.de\nISERV_CLIENT_ID=sportoase_abc123\nISERV_CLIENT_SECRET=xyz789...\n```\n\n### 2.3 Workflow neu starten\n\nNach dem Setzen der Secrets:\n1. Workflow stoppen\n2. Workflow neu starten\n3. Login-Seite aufrufen\n\n➡️ Der **\"Mit IServ anmelden\"** Button sollte jetzt sichtbar sein!\n\n## Schritt 3: Testen\n\n### 3.1 IServ-Login testen\n\n1. Auf der SportOase Login-Seite auf **\"Mit IServ anmelden\"** klicken\n2. Weiterleitung zu IServ → Anmeldung mit IServ-Benutzername und Passwort\n3. Bestätigung der Datenweitergabe (beim ersten Login)\n4. Automatische Weiterleitung zurück zu SportOase\n5. ✅ Erfolgreich angemeldet!\n\n### 3.2 Admin-Rechte prüfen\n\n**Admin-Account** (`morelli.maurizio@kgs-pattensen.de`):\n- ✅ Zugriff auf Admin-Bereich\n- ✅ Kann Buchungen verwalten\n- ✅ Kann Slots blockieren\n- ✅ Kann Slot-Namen ändern\n- ✅ Kann Passwort ändern\n\n**Lehrer-Accounts** (alle anderen):\n- ✅ Können buchen\n- ✅ Können eigene Buchungen sehen\n- ❌ **Kein** Zugriff auf Admin-Funktionen\n\n## Technische Details\n\n### OAuth-Endpunkte\n\nIServ stellt folgende OAuth2/OIDC-Endpunkte bereit:\n\n```\nDiscovery: https://kgs-pattensen.de/.well-known/openid-configuration\nAuthorization: https://kgs-pattensen.de/iserv/oauth/v2/auth\nToken: https://kgs-pattensen.de/iserv/oauth/v2/token\nUserInfo: https://kgs-pattensen.de/iserv/public/oauth/userinfo\n```\n\n### Datenfluss\n\n1. Benutzer klickt auf \"Mit IServ anmelden\"\n2. Weiterleitung zu IServ Authorization Endpoint\n3. Benutzer meldet sich bei IServ an\n4. IServ leitet zurück mit Authorization Code\n5. SportOase tauscht Code gegen Access Token\n6. SportOase ruft UserInfo-Endpoint auf\n7. Benutzer wird in SportOase angelegt/aktualisiert\n8. Session wird erstellt → Benutzer ist angemeldet\n\n### Sicherheit\n\n✅ **OAuth2 + OpenID Connect** (Standard-Protokoll für SSO)\n✅ **HTTPS** erforderlich (automatisch in Replit)\n✅ **State-Parameter** gegen CSRF-Angriffe\n✅ **Client-Secret** wird sicher auf Server gespeichert (nie im Browser)\n✅ **Automatische Token-Verwaltung** durch Authlib\n\n## Fehlerbehebung\n\n### \"IServ-Login ist nicht konfiguriert\"\n\n➡️ Prüfen Sie, ob `ISERV_CLIENT_ID` und `ISERV_CLIENT_SECRET` in Replit Secrets gesetzt sind\n\n### \"Fehler beim IServ-Login\"\n\n➡️ Prüfen Sie:\n1. Redirect URI in IServ korrekt eingetragen?\n2. Client-ID und Client-Secret korrekt kopiert?\n3. IServ-Domain korrekt (`kgs-pattensen.de` ohne `https://`)?\n\n### Button \"Mit IServ anmelden\" nicht sichtbar\n\n➡️ Secrets gesetzt und Workflow neu gestartet?\n\n### Benutzer erhält keine Admin-Rechte\n\n➡️ Ist die E-Mail-Adresse exakt `morelli.maurizio@kgs-pattensen.de`?\n\n## Duales Login-System\n\nDie SportOase-App unterstützt **beide** Login-Methoden gleichzeitig:\n\n1. **Traditioneller Login** (Benutzername + Passwort)\n   - Für bestehende Accounts\n   - Für Notfälle, falls IServ nicht erreichbar ist\n\n2. **IServ SSO Login**\n   - Für alle IServ-Benutzer\n   - Automatische Account-Erstellung\n   - Keine separaten Passwörter notwendig\n\n## Support\n\nBei Fragen oder Problemen:\n- **IServ-Konfiguration**: Kontaktieren Sie Ihren IServ-Administrator\n- **SportOase-App**: Kontaktieren Sie `sportoase.kg@gmail.com`\n\n## Changelog\n\n- **2025-11-24**: IServ SSO Integration implementiert\n- Unterstützung für OAuth2/OpenID Connect\n- Automatische Rollenzuweisung (Admin vs. Lehrer)\n- Duales Login-System (traditionell + SSO)\n","size_bytes":5911},"test_email_smtp.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nTest-Script für E-Mail-Versand via SMTP\nTestet, ob Buchungsbenachrichtigungen an sportoase.kgs@gmail.com funktionieren\n\"\"\"\n\nimport os\nimport sys\n\n# Füge aktuelles Verzeichnis zum Python-Pfad hinzu\nsys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))\n\nfrom email_service import send_booking_notification\n\ndef test_email_sending():\n    \"\"\"Testet den E-Mail-Versand mit einem Beispiel-Buchung\"\"\"\n    \n    print(\"=\" * 60)\n    print(\"TEST: E-Mail-Versand für Buchungsbenachrichtigungen\")\n    print(\"=\" * 60)\n    \n    # Prüfe SMTP-Konfiguration\n    smtp_user = os.environ.get('SMTP_USER')\n    smtp_pass = os.environ.get('SMTP_PASS')\n    \n    print(f\"\\n✓ SMTP_USER: {smtp_user if smtp_user else '❌ NICHT GESETZT'}\")\n    print(f\"✓ SMTP_PASS: {'✓ Gesetzt' if smtp_pass else '❌ NICHT GESETZT'}\")\n    \n    if not smtp_user or not smtp_pass:\n        print(\"\\n❌ FEHLER: SMTP-Zugangsdaten sind nicht konfiguriert!\")\n        print(\"Bitte setzen Sie SMTP_USER und SMTP_PASS in den Replit Secrets.\")\n        return False\n    \n    # Test-Buchungsdaten\n    booking_data = {\n        'teacher_name': 'Max Mustermann',\n        'teacher_class': '5A',\n        'date': '2025-11-18',\n        'weekday': 'Montag',\n        'period': 3,\n        'offer_label': 'Konflikt-Reset & Deeskalation',\n        'offer_type': 'fest',\n        'students_json': '[{\"name\": \"Anna Schmidt\", \"klasse\": \"5A\"}, {\"name\": \"Tom Weber\", \"klasse\": \"5B\"}]'\n    }\n    \n    admin_email = 'sportoase.kgs@gmail.com'\n    \n    print(f\"\\n📧 Sende Test-E-Mail an: {admin_email}\")\n    print(f\"   Lehrkraft: {booking_data['teacher_name']}\")\n    print(f\"   Datum: {booking_data['date']} ({booking_data['weekday']})\")\n    print(f\"   Stunde: {booking_data['period']}. Stunde\")\n    print(f\"   Angebot: {booking_data['offer_label']}\")\n    \n    # E-Mail senden\n    success = send_booking_notification(booking_data, admin_email)\n    \n    if success:\n        print(\"\\n✅ E-Mail wurde erfolgreich versendet!\")\n        print(f\"✅ Überprüfen Sie das Postfach: {admin_email}\")\n        return True\n    else:\n        print(\"\\n❌ E-Mail-Versand fehlgeschlagen!\")\n        print(\"Überprüfen Sie die Logs für Details.\")\n        return False\n\nif __name__ == '__main__':\n    test_email_sending()\n","size_bytes":2275},"PRODUCTION_DEPLOYMENT_TODO.md":{"content":"# Production Deployment Checkliste - SportOase\n\n## Status: VORBEREITET - Warte auf IServ-Konfiguration\n\n---\n\n## ✅ ERLEDIGT\n\n### Sicherheit & Konfiguration\n- [x] SESSION_SECRET wird streng erzwungen (keine Fallback-Werte)\n- [x] Keine sensiblen Daten in Logs (DATABASE_URL entfernt)\n- [x] IServ SSO Integration implementiert (OAuth2/OpenID Connect)\n- [x] CSRF-Protection auf allen POST-Routes\n- [x] Render Production Database konfiguriert (DATABASE_URL in Production-Env gesetzt)\n\n### Datenbank\n- [x] User-Model erweitert für OAuth (oauth_provider, oauth_id, nullable password)\n- [x] Migration für OAuth-Felder vorhanden (migration_add_oauth_fields.py)\n- [x] Dual-Login unterstützt (Passwort + IServ SSO)\n\n### Code-Qualität\n- [x] Architect Review durchgeführt - APPROVED\n- [x] Keine Mock-Daten im Code\n- [x] Saubere Fehlerbehandlung\n\n---\n\n## ⏳ NÄCHSTE SCHRITTE - PRODUCTION READY MACHEN\n\n### 1. IServ-Integration aktivieren (BLOCKIERT - braucht Admin)\n\n**Was fehlt:**\n```bash\n# Diese 3 Umgebungsvariablen müssen in Replit Secrets gesetzt werden:\nISERV_BASE_URL=https://kgs-pattensen.de  # IServ-Server-URL\nISERV_CLIENT_ID=<vom IServ-Admin>        # OAuth Client-ID\nISERV_CLIENT_SECRET=<vom IServ-Admin>    # OAuth Client-Secret\n```\n\n**Wo bekommt man das:**\n- IServ-Administrator muss im IServ-Panel konfigurieren:\n  - Pfad: `Verwaltung → System → Single-Sign-On`\n  - Neue OAuth2-App erstellen\n  - Redirect URI: `https://sportoase.app/oauth/callback`\n  - Scopes: `openid profile email`\n\n**Was passiert danach:**\n- Button \"Mit IServ anmelden\" erscheint auf Login-Seite\n- IServ-User können sich direkt mit Schul-Zugangsdaten anmelden\n- Rolle wird automatisch zugewiesen:\n  - morelli.maurizio@kgs-pattensen.de → Admin\n  - Alle anderen IServ-User → Lehrer\n\n---\n\n### 2. Production-Datenbank Migration durchführen\n\n**Aktueller Stand:**\n- Production DATABASE_URL ist gesetzt ✓\n- Migration-Script existiert (migration_add_oauth_fields.py) ✓\n\n**Was zu tun ist:**\n```bash\n# WICHTIG: VOR dem Render-Deployment ausführen!\n# Option A: Migration direkt auf Render-DB laufen lassen\npython3 migration_add_oauth_fields.py\n\n# Option B: Falls existierende Production-DB vorhanden\n# 1. Backup der Production-DB erstellen\n# 2. Migration testen\n# 3. Bei Erfolg: Live schalten\n```\n\n**Was die Migration macht:**\n- Fügt `oauth_provider` (VARCHAR 50) zu User-Tabelle hinzu\n- Fügt `oauth_id` (VARCHAR 255) zu User-Tabelle hinzu\n- Macht `password_hash` nullable (für OAuth-only User)\n- Erstellt unique constraint auf (oauth_provider, oauth_id)\n\n---\n\n### 3. SMTP/Email-Konfiguration überprüfen\n\n**Aktueller Stand:**\n- Gmail-Integration ist als Connector vorhanden (needs setup)\n- SMTP-Variablen für Fallback sollten gesetzt sein\n\n**Was zu tun ist:**\n```bash\n# Diese Variablen sollten in Production gesetzt sein:\nSMTP_HOST=smtp.gmail.com\nSMTP_PORT=587\nSMTP_USER=sportoase.kg@gmail.com\nSMTP_PASS=<App-Passwort>\nSMTP_FROM=sportoase.kg@gmail.com\nADMIN_EMAIL=sportoase.kg@gmail.com\n```\n\n**ODER:** Gmail-Connector richtig konfigurieren (bevorzugt)\n\n---\n\n### 4. Render Deployment vorbereiten\n\n**Was zu überprüfen:**\n- [ ] Alle Environment Variables in Render gesetzt:\n  - SESSION_SECRET (neuen zufälligen Wert generieren!)\n  - DATABASE_URL (bereits gesetzt ✓)\n  - ISERV_BASE_URL\n  - ISERV_CLIENT_ID\n  - ISERV_CLIENT_SECRET\n  - SMTP_* Variablen\n\n- [ ] Render Build-Settings:\n  ```\n  Build Command: pip install -r requirements.txt\n  Start Command: gunicorn --bind 0.0.0.0:$PORT --reuse-port main:app\n  ```\n\n- [ ] Python Version: 3.11\n\n---\n\n### 5. Nach Deployment: Testing\n\n**Test-Checkliste:**\n- [ ] Normale Login funktioniert (Passwort)\n- [ ] IServ SSO Login funktioniert\n- [ ] Admin-User (morelli.maurizio@kgs-pattensen.de) hat Admin-Rechte\n- [ ] Andere IServ-User haben Lehrer-Rechte\n- [ ] Buchungen können erstellt werden\n- [ ] Email-Benachrichtigungen funktionieren\n- [ ] Dashboard lädt korrekt\n- [ ] Keine Fehler in Production-Logs\n\n---\n\n## 📝 Wichtige Notizen\n\n### Sicherheit\n- **SESSION_SECRET**: NIEMALS den Replit-Wert in Production verwenden! Neuen generieren.\n- **Database Credentials**: Bereits sicher (nicht in Logs)\n- **OAuth Secrets**: Werden vom IServ-Admin bereitgestellt\n\n### Rollback-Plan\nFalls nach Deployment Probleme auftreten:\n1. IServ-Button kann durch Entfernen der ISERV_* Variablen deaktiviert werden\n2. Traditioneller Login bleibt immer funktionsfähig\n3. Database-Backup vor Migration erstellen!\n\n### Support-Kontakte\n- IServ-Administrator: [Name eintragen]\n- Render Support: https://render.com/support\n- Gmail API: Google Workspace Admin\n\n---\n\n## 🎯 Deployment-Reihenfolge (WICHTIG!)\n\n```\n1. IServ-Admin kontaktieren → Client-ID/Secret erhalten\n   ↓\n2. Environment Variables in Render setzen (inkl. neues SESSION_SECRET!)\n   ↓\n3. Database-Backup erstellen\n   ↓\n4. Migration auf Production-DB ausführen\n   ↓\n5. App auf Render deployen\n   ↓\n6. Testing durchführen (siehe Checkliste oben)\n   ↓\n7. Bei Erfolg: User informieren, dass IServ-Login verfügbar ist\n```\n\n---\n\n**Zuletzt aktualisiert:** 24. November 2025\n**Version:** 1.0 - IServ SSO Integration abgeschlossen\n","size_bytes":5114}},"version":2}