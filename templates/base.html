<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}SportOase Buchungssystem{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    {% if session.user_id %}
    <div class="top-nav">
        <div class="container">
            <nav>
                <a href="{{ url_for('dashboard') }}">Dashboard</a>
                {% if session.user_role == 'admin' %}
                <a href="{{ url_for('admin') }}">Admin</a>
                <div class="notification-container">
                    <button class="notification-bell" onclick="toggleNotifications()" aria-label="Benachrichtigungen">
                        ðŸ””
                        <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                    </button>
                    <div class="notification-dropdown" id="notificationDropdown">
                        <div class="notification-header">
                            <h4>Benachrichtigungen</h4>
                            <button class="mark-all-read" onclick="markAllAsRead()">Alle als gelesen markieren</button>
                        </div>
                        <div class="notification-list" id="notificationList">
                            <p class="no-notifications">Keine neuen Benachrichtigungen</p>
                        </div>
                    </div>
                </div>
                {% endif %}
                <a href="{{ url_for('logout') }}">Logout</a>
            </nav>
        </div>
    </div>
    {% endif %}
    
    <main class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="messages">
                    {% for category, message in messages %}
                        <div class="message message-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        
        {% block content %}{% endblock %}
    </main>
    
    <div class="credits-button" onclick="toggleCredits()">?</div>
    
    <div id="creditsModal" class="credits-modal">
        <div class="credits-content">
            <span class="credits-close" onclick="toggleCredits()">&times;</span>
            <h3>Credits</h3>
            <p><strong>Programmed in:</strong> Python version 3.13.4</p>
            <p><strong>using</strong> Flask-SQLAlchemy-3.1.1 blinker-1.9.0 click-8.3.0 dnspython-2.8.0 email_validator-2.3.0 flask-3.1.2 greenlet-3.2.4 gunicorn-23.0.0 idna-3.11 itsdangerous-2.2.0 jinja2-3.1.6 markupsafe-3.0.3 packaging-25.0 psycopg2-binary-2.9.11 python-dotenv-1.2.1 pytz-2025.2 sqlalchemy-2.0.44 typing-extensions-4.15.0 werkzeug-3.1.3</p>
            <p><strong>Security:</strong> CloudFlare secured SSL</p>
            <p><strong>Server:</strong> SSL / AES-256 Encrypted Server</p>
        </div>
    </div>
    
    <script>
        function toggleCredits() {
            var modal = document.getElementById('creditsModal');
            if (modal.style.display === 'block') {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'block';
            }
        }
        
        window.onclick = function(event) {
            var modal = document.getElementById('creditsModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Notification System (nur fÃ¼r Admins)
        {% if session.user_role == 'admin' %}
        let notificationSound = null;
        let eventSource = null;

        function toggleNotifications() {
            const dropdown = document.getElementById('notificationDropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        function updateNotificationBadge(count) {
            const badge = document.getElementById('notificationBadge');
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = (now - date) / 1000;
            
            if (diff < 60) return 'Gerade eben';
            if (diff < 3600) return Math.floor(diff / 60) + ' Min';
            if (diff < 86400) return Math.floor(diff / 3600) + ' Std';
            return date.toLocaleDateString('de-DE');
        }

        function renderNotification(notification) {
            const div = document.createElement('div');
            div.className = 'notification-item' + (notification.is_read ? ' read' : '');
            div.innerHTML = `
                <div class="notification-content">
                    <p class="notification-message">${notification.message}</p>
                    <span class="notification-time">${formatDate(notification.created_at)}</span>
                </div>
                ${!notification.is_read ? `<button class="mark-read-btn" onclick="markAsRead(${notification.id})">âœ“</button>` : ''}
            `;
            return div;
        }

        function loadRecentNotifications() {
            fetch('/api/notifications/recent?limit=10')
                .then(response => response.json())
                .then(data => {
                    const list = document.getElementById('notificationList');
                    if (data.success && data.notifications.length > 0) {
                        list.innerHTML = '';
                        data.notifications.forEach(notif => {
                            list.appendChild(renderNotification(notif));
                        });
                    } else {
                        list.innerHTML = '<p class="no-notifications">Keine neuen Benachrichtigungen</p>';
                    }
                })
                .catch(error => console.error('Fehler beim Laden der Benachrichtigungen:', error));
        }

        function updateUnreadCount() {
            fetch('/api/notifications/unread_count')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateNotificationBadge(data.count);
                    }
                })
                .catch(error => console.error('Fehler beim Aktualisieren des ZÃ¤hlers:', error));
        }

        function markAsRead(notificationId) {
            fetch(`/api/notifications/${notificationId}/mark_read`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    csrf_token: '{{ csrf_token }}'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadRecentNotifications();
                    updateUnreadCount();
                }
            })
            .catch(error => console.error('Fehler beim Markieren:', error));
        }

        function markAllAsRead() {
            fetch('/api/notifications/mark_all_read', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    csrf_token: '{{ csrf_token }}'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadRecentNotifications();
                    updateNotificationBadge(0);
                }
            })
            .catch(error => console.error('Fehler beim Markieren aller:', error));
        }

        function playNotificationSound() {
            if (!notificationSound) {
                notificationSound = new Audio('data:audio/wav;base64,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');
            }
            notificationSound.play().catch(e => console.log('Sound play failed:', e));
        }

        function connectSSE() {
            if (eventSource) {
                eventSource.close();
            }

            eventSource = new EventSource('/notifications/stream');

            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'ping') {
                        return;
                    }
                    
                    if (data.type === 'new_booking') {
                        playNotificationSound();
                        updateNotificationBadge(data.unread_count);
                        loadRecentNotifications();
                    }
                } catch (error) {
                    console.error('Fehler beim Verarbeiten der SSE-Nachricht:', error);
                }
            };

            eventSource.onerror = function(error) {
                console.error('SSE-Fehler:', error);
                eventSource.close();
                setTimeout(connectSSE, 5000);
            };
        }

        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('notificationDropdown');
            const bell = document.querySelector('.notification-bell');
            
            if (!dropdown.contains(event.target) && !bell.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            updateUnreadCount();
            loadRecentNotifications();
            connectSSE();
        });

        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
        {% endif %}
    </script>
</body>
</html>
